# MAGIC Client 使用说明

## 概述

MAGIC Client 是基于 ARINC 839-2014 标准的航空电子 Diameter 通信客户端，用于飞机与地面服务器之间的数据通信管理。

## 系统要求

- Linux 操作系统（已测试：Ubuntu/Debian/CentOS）
- freeDiameter 1.6.0 或更高版本
- 已安装的 MAGIC 字典扩展（dict_magic_839.fdx）
- 有效的 TLS 证书（客户端证书、私钥、CA 证书）

## 快速启动

### 1. 编译程序

```bash
cd /home/zhuwuhui/freeDiameter/magic_client
mkdir -p build && cd build
cmake ..
make
```

编译成功后，可执行文件位于：`build/magic_client`

### 2. 准备配置文件

需要两个配置文件：

#### a) freeDiameter 配置文件（`magic_client.conf`）
```properties
# Diameter 身份标识
Identity = "magic-client.example.com";
Realm = "example.com";

# 禁用 SCTP 和 IPv6
No_SCTP;
No_IPv6;

# TLS 证书配置（使用绝对路径）
TLS_Cred = "/path/to/client.crt", "/path/to/client.key";
TLS_CA = "/path/to/ca.crt";

# 加载 MAGIC 字典扩展
LoadExtension = "/path/to/dict_magic_839.fdx";

# 连接到服务器
ConnectPeer = "magic-server.example.com" { 
    ConnectTo = "192.168.1.100"; 
    Port = 5870; 
};
```

#### b) MAGIC 客户端配置文件（`magic.conf`）
```properties
# 客户端标识
CLIENT_ID = EFB-001
TAIL_NUMBER = B-1234
AIRCRAFT_TYPE = A320

# Diameter 目标域
DESTINATION_REALM = example.com

# 带宽需求（单位：bit/s）
MAX_BW = 10000000
REQUESTED_BW = 5000000
REQUIRED_BW = 1000000

# QoS 配置
PRIORITY = 3
QOS_LEVEL = 2

# 认证信息
USERNAME = pilot001
CLIENT_PASSWORD = password123
SERVER_PASSWORD = serverpass456

# 会话配置
PROFILE_NAME = IP_DATA
TIMEOUT = 300
AUTO_RECONNECT = 1
KEEP_ALIVE_INTERVAL = 30
```

### 3. 运行客户端

```bash
cd /home/zhuwuhui/freeDiameter/magic_client/build

# 标准运行
./magic_client -c /path/to/magic_client.conf

# 调试模式（显示详细日志）
./magic_client -c /path/to/magic_client.conf -dd

# 完整调试模式
./magic_client -c /path/to/magic_client.conf -ddd
```

## 命令行界面

程序启动后会进入交互式命令行界面：

```
╔══════════════════════════════════════════════╗
║                                              ║
║      MAGIC Client - ARINC 839-2014          ║
║      航空电子 Diameter 通信客户端            ║
║                                              ║
╚══════════════════════════════════════════════╝

当前状态: 未连接
服务器: 未配置
会话: 无

MAGIC> 
```

## 可用命令

### 基础命令

#### `help` - 显示帮助信息
```
MAGIC> help
```
显示所有可用命令及其说明。

#### `status` - 查看当前状态
```
MAGIC> status
```
显示连接状态、会话信息、带宽分配等。

#### `quit` 或 `exit` - 退出程序
```
MAGIC> quit
```

### 连接管理

#### `connect` - 连接到服务器
```
MAGIC> connect
```
建立与地面服务器的 Diameter 连接。

#### `disconnect` - 断开连接
```
MAGIC> disconnect
```
断开与服务器的连接，但不退出程序。

### MAGIC 协议命令

#### `mcar` - 客户端认证请求（MAGIC Client Authentication Request）
```
MAGIC> mcar
```
向服务器发送认证请求，建立安全会话。这是使用 MAGIC 服务的第一步。

**使用场景**：
- 飞机起飞后首次连接地面网络
- 连接断开后重新认证

#### `mccr` - 通信参数变更请求（MAGIC Communication Change Request）
```
MAGIC> mccr
```
请求修改当前通信参数（如带宽、QoS 等级）。

**使用场景**：
- 需要更高带宽（如视频会议）
- 降低带宽以节省成本
- 调整 QoS 等级

#### `mntr` - 通知报告（MAGIC Notification Report）
```
MAGIC> mntr
```
向服务器发送通知或事件报告。

**使用场景**：
- 飞行阶段变化（起飞→巡航→降落）
- 重要事件通知

#### `mscr` - 状态变更报告（MAGIC Status Change Report）
```
MAGIC> mscr
```
报告客户端状态变化。

**使用场景**：
- DLM（数据链路模块）状态变化
- 链路质量变化

#### `msxr` - 状态查询请求（MAGIC Status Exchange Request）
```
MAGIC> msxr
```
查询当前链路和服务状态。

**使用场景**：
- 查看所有可用的数据链路模块
- 检查链路质量和带宽分配
- 诊断连接问题

#### `madr` - 计费数据请求（MAGIC Accounting Data Request）
```
MAGIC> madr
```
请求或提交计费数据记录（CDR）。

**使用场景**：
- 查询当前计费信息
- 上传本地 CDR 记录

#### `macr` - 计费控制请求（MAGIC Accounting Control Request）
```
MAGIC> macr
```
计费会话控制（启动、停止、更新）。

**使用场景**：
- 开始新的计费会话
- 停止计费会话
- 请求中间计费报告

#### `str` - 会话终止请求（Session Termination Request）
```
MAGIC> str
```
优雅地终止当前 Diameter 会话。

**使用场景**：
- 正常结束会话
- 飞机降落前关闭数据连接

## 典型使用流程

### 场景 1：飞机起飞后建立通信

```bash
# 1. 启动客户端
./magic_client -c /path/to/magic_client.conf

# 2. 连接到服务器
MAGIC> connect

# 3. 等待连接建立成功（查看日志）

# 4. 发送认证请求
MAGIC> mcar

# 5. 认证成功后，查看状态
MAGIC> status

# 6. 如需查询可用链路
MAGIC> msxr
```

### 场景 2：请求更高带宽

```bash
# 1. 修改配置文件中的带宽参数（或使用配置命令）

# 2. 发送参数变更请求
MAGIC> mccr

# 3. 查看新的带宽分配
MAGIC> status
```

### 场景 3：飞机降落前断开连接

```bash
# 1. 终止会话
MAGIC> str

# 2. 等待会话终止确认

# 3. 断开 Diameter 连接
MAGIC> disconnect

# 4. 退出程序
MAGIC> quit
```

### 场景 4：诊断连接问题

```bash
# 1. 查看整体状态
MAGIC> status

# 2. 查询链路状态
MAGIC> msxr

# 3. 检查日志输出
# 查看终端中的 freeDiameter 日志信息
```

## 配置参数说明

### 带宽参数
- `MAX_BW`：客户端能接受的最大下行带宽（bit/s）
- `REQUESTED_BW`：希望获得的下行带宽
- `REQUIRED_BW`：最低保障下行带宽（低于此值不可用）
- `REQUESTED_RETURN_BW`：请求的上行带宽
- `REQUIRED_RETURN_BW`：最低保障上行带宽

### QoS 参数
- `QOS_LEVEL`：服务质量等级
  - 0 = Bronze（经济型）
  - 1 = Silver（标准型）
  - 2 = Gold（高级型）
  - 3 = Platinum（白金型）

- `PRIORITY`：优先级（1-8，数字越小优先级越高）
  - 1-2：紧急（Emergency）
  - 3-4：高优先级（High）
  - 5-6：正常（Normal）
  - 7-8：低优先级（Low）

### 会话参数
- `PROFILE_NAME`：会话类型
  - `VOICE`：语音通话
  - `VIDEO`：视频通话
  - `IP_DATA`：互联网数据
  - `CREW_DATA`：机组数据
  - `MAINT_DATA`：维护数据

- `TIMEOUT`：会话超时时间（秒）
- `KEEP_ALIVE_INTERVAL`：心跳间隔（秒）
- `AUTO_RECONNECT`：是否自动重连（0=否，1=是）

## 故障排查

### 问题 1：无法连接到服务器

**症状**：
```
ERROR: 连接失败
```

**可能原因及解决方法**：
1. 检查网络连接
   ```bash
   ping 192.168.1.100
   telnet 192.168.1.100 5870
   ```

2. 检查防火墙设置
   ```bash
   sudo iptables -L | grep 5870
   ```

3. 验证 TLS 证书
   ```bash
   openssl verify -CAfile ca.crt client.crt
   ```

4. 检查服务器地址配置
   - 确认 `magic_client.conf` 中的 `ConnectPeer` 配置正确

### 问题 2：认证失败

**症状**：
```
ERROR: MCAR 认证失败: Result-Code = 5012
```

**可能原因及解决方法**：
1. 检查用户名密码
   - 确认 `magic.conf` 中 `USERNAME` 和 `CLIENT_PASSWORD` 正确

2. 检查证书有效期
   ```bash
   openssl x509 -in client.crt -noout -dates
   ```

3. 查看服务器日志
   - 联系服务器管理员查看拒绝原因

### 问题 3：字典初始化失败

**症状**：
```
ERROR: MAGIC 字典初始化失败
```

**解决方法**：
1. 确认扩展已加载
   - 检查日志中是否有 "Loaded extensions: dict_magic_839.fdx"

2. 重新编译扩展
   ```bash
   cd /home/zhuwuhui/freeDiameter/build
   make dict_magic_839
   ```

3. 检查扩展路径
   - 确认 `LoadExtension` 指向正确的 `.fdx` 文件

### 问题 4：程序启动后立即退出

**可能原因**：
1. 配置文件路径错误
2. 配置文件格式错误
3. 必需的库文件缺失

**解决方法**：
```bash
# 使用调试模式查看详细错误
./magic_client -c /path/to/config -ddd

# 检查依赖库
ldd ./magic_client
```

## 日志级别

使用 `-d` 参数控制日志详细程度：

- 无参数：只显示错误和重要信息
- `-d`：显示警告信息
- `-dd`：显示信息级别日志
- `-ddd`：显示调试信息
- `-dddd`：显示详细调试信息（包括消息内容）

## 高级功能

### 流量过滤规则（TFT）

在配置文件中添加：

```properties
# 地面到飞机的过滤规则
TFT_GROUND.1 = permit in ip from 10.0.0.0/8 to any
TFT_GROUND.2 = permit in tcp from any to any port 80
TFT_GROUND.3 = permit in tcp from any to any port 443

# 飞机到地面的过滤规则
TFT_AIRCRAFT.1 = permit out ip from any to 10.0.0.0/8
TFT_AIRCRAFT.2 = permit out udp from any to any port 53
```

### 端口映射（NAPT）

```properties
# NAPT 规则
NAPT.1 = tcp 8080 -> 80
NAPT.2 = tcp 8443 -> 443
NAPT.3 = udp 5353 -> 53
```

## 性能优化建议

1. **选择合适的 QoS 等级**
   - 语音/视频通话：Gold 或 Platinum
   - 网页浏览：Silver
   - 文件下载：Bronze

2. **合理设置带宽请求**
   - 不要请求超过实际需要的带宽
   - 设置合理的 REQUIRED_BW 作为底线

3. **使用连接保持**
   - 启用 `AUTO_RECONNECT`
   - 设置合理的 `KEEP_ALIVE_INTERVAL`（推荐 30-60 秒）

4. **定期查询状态**
   - 使用 `msxr` 命令监控链路质量
   - 根据链路状态调整参数

## 安全建议

1. **证书管理**
   - 定期更新证书（建议每年）
   - 妥善保管私钥文件
   - 使用强密码保护私钥

2. **密码策略**
   - 使用强密码（至少 12 位，包含大小写字母、数字、特殊字符）
   - 定期更换密码
   - 不要在配置文件注释中写明密码

3. **访问控制**
   - 限制配置文件访问权限
   ```bash
   chmod 600 magic.conf
   chmod 600 magic_client.conf
   ```

4. **审计日志**
   - 保存程序运行日志
   - 定期检查异常行为

## 技术支持

### 报告问题

遇到问题时，请收集以下信息：

1. 完整的错误日志
   ```bash
   ./magic_client -c config -dddd 2>&1 | tee magic_client.log
   ```

2. 系统信息
   ```bash
   uname -a
   gcc --version
   ```

3. freeDiameter 版本
   ```bash
   fd_dict_test -v
   ```

4. 配置文件（去除敏感信息）

### 常用诊断命令

```bash
# 检查进程状态
ps aux | grep magic_client

# 检查网络连接
netstat -antp | grep magic_client

# 查看系统日志
journalctl -u magic_client -f

# 监控资源使用
top -p $(pidof magic_client)
```

## 附录

### A. 命令代码参考

| 命令 | 代码 | 说明 |
|------|------|------|
| MCAR/MCAA | 100000 | 客户端认证 |
| MCCR/MCCA | 100001 | 通信参数变更 |
| MNTR/MNTA | 100002 | 通知报告 |
| MSCR/MSCA | 100003 | 状态变更报告 |
| MSXR/MSXA | 100004 | 状态查询 |
| MADR/MADA | 100005 | 计费数据 |
| MACR/MACA | 100006 | 计费控制 |

### B. Result-Code 参考

| 代码 | 含义 | 说明 |
|------|------|------|
| 2001 | SUCCESS | 操作成功 |
| 3001 | COMMAND_UNSUPPORTED | 不支持的命令 |
| 3002 | UNABLE_TO_DELIVER | 无法投递 |
| 3003 | REALM_NOT_SERVED | 域不可达 |
| 5001 | AVP_UNSUPPORTED | 不支持的 AVP |
| 5004 | INVALID_AVP_VALUE | 无效的 AVP 值 |
| 5012 | UNABLE_TO_COMPLY | 无法执行 |

### C. 文件位置

- 主程序：`/home/zhuwuhui/freeDiameter/magic_client/build/magic_client`
- 配置文件：`/home/zhuwuhui/freeDiameter/magic_client/magic_client.conf`
- MAGIC 配置：`/home/zhuwuhui/freeDiameter/magic_client/magic.conf`
- 字典扩展：`/home/zhuwuhui/freeDiameter/build/extensions/dict_magic_839.fdx`
- 证书目录：`/home/zhuwuhui/freeDiameter/certs/`

---

**文档版本**：1.0  
**最后更新**：2025-11-22  
**适用版本**：MAGIC Client 1.0 / freeDiameter 1.6.0
