# MAGIC å¤šä¼šè¯å¹¶å‘æ”¯æŒ

## ğŸ“‹ æ¦‚è¿°

æ ¹æ® ARINC 839-2014 æ ‡å‡†,MAGIC ç³»ç»Ÿç°å·²æ”¯æŒå®¢æˆ·ç«¯å¹¶å‘ç»´æŠ¤å¤šä¸ªç‹¬ç«‹çš„ Diameter ä¼šè¯ã€‚æ¯ä¸ªä¼šè¯å¯¹åº”ä¸€æ¡ç‹¬ç«‹çš„é€šä¿¡é“¾è·¯,é€šè¿‡å”¯ä¸€çš„ Session-Id è¿›è¡Œæ ‡è¯†å’Œç®¡ç†ã€‚

## ï¿½ï¿½ è®¾è®¡åŸåˆ™

### ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
ä¼šè¯1: MCAR â†’ MCCR(create) â†’ MCCR(modify) â†’ ... â†’ STR
ä¼šè¯2: MCAR â†’ MCCR(create) â†’ MCCR(modify) â†’ ... â†’ STR  
ä¼šè¯3: MCAR â†’ MCCR(create) â†’ ...
```

- **æ¯ä¸ª MCAR åˆ›å»ºä¸€ä¸ªæ–°çš„ Diameter ä¼šè¯**
- **æ¯ä¸ªä¼šè¯æœ‰å”¯ä¸€çš„ Session-Id**
- **ä¼šè¯ä¹‹é—´å®Œå…¨ç‹¬ç«‹,äº’ä¸å¹²æ‰°**
- **å®¢æˆ·ç«¯æœ€å¤šå¯åŒæ—¶ç»´æŠ¤ 10 ä¸ªæ´»åŠ¨ä¼šè¯**

### å‘½ä»¤è¯­ä¹‰

| å‘½ä»¤ | ä½œç”¨ | Session-Id è¦æ±‚ |
|------|------|----------------|
| MCAR | åˆ›å»ºæ–°ä¼šè¯ | è‡ªåŠ¨ç”Ÿæˆæ–° ID |
| MCCR (é¦–æ¬¡) | å»ºç«‹é“¾è·¯ (OpenLink) | ä½¿ç”¨å½“å‰ä¼šè¯ ID |
| MCCR (åç»­) | ä¿®æ”¹é“¾è·¯ (ChangeLink) | ä½¿ç”¨å½“å‰ä¼šè¯ ID |
| STR | ç»ˆæ­¢ä¼šè¯ (CloseLink) | æŒ‡å®šè¦ç»ˆæ­¢çš„ Session-Id |

## ğŸ“ æ–°å¢æ–‡ä»¶

### æœåŠ¡å™¨ç«¯ (MAGIC)

1. **`extensions/app_magic/magic_session.h`**
   - æœåŠ¡å™¨ç«¯ä¼šè¯ç®¡ç†æ¥å£
   - è·Ÿè¸ªæ¯ä¸ªå®¢æˆ·ç«¯çš„æ´»åŠ¨ä¼šè¯å’Œé“¾è·¯åˆ†é…
   - æ”¯æŒæœ€å¤š 100 ä¸ªå¹¶å‘ä¼šè¯

2. **`extensions/app_magic/magic_session.c`**
   - ä¼šè¯ç®¡ç†å®ç°
   - Session-Id ç´¢å¼•
   - é“¾è·¯èµ„æºè·Ÿè¸ª

### å®¢æˆ·ç«¯ (magic_client)

1. **`magic_client/session_manager.h`**
   - å®¢æˆ·ç«¯ä¼šè¯ç®¡ç†æ¥å£
   - æ”¯æŒæœ€å¤š 10 ä¸ªå¹¶å‘ä¼šè¯
   - Session-Id ç”Ÿæˆå’Œç®¡ç†

2. **`magic_client/session_manager.c`**
   - ä¼šè¯ç®¡ç†å®ç°
   - ä¼šè¯çŠ¶æ€è·Ÿè¸ª
   - å½“å‰ä¼šè¯åˆ‡æ¢

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### æœåŠ¡å™¨ç«¯

1. **`extensions/app_magic/app_magic.h`**
   - æ·»åŠ  `SessionManager session_mgr` åˆ°å…¨å±€ä¸Šä¸‹æ–‡

2. **`extensions/app_magic/app_magic.c`**
   - åˆå§‹åŒ–/æ¸…ç†ä¼šè¯ç®¡ç†å™¨

3. **`extensions/app_magic/magic_cic.c`**
   - MCCR å¤„ç†æ”¯æŒå¤šä¼šè¯
   - é€šè¿‡ Session-Id åŒºåˆ†ä¸åŒé“¾è·¯è¯·æ±‚
   - å…è®¸åŒä¸€å®¢æˆ·ç«¯å¹¶å‘å¤šä¸ª MCCR

4. **`extensions/app_magic/CMakeLists.txt`**
   - æ·»åŠ  `magic_session.c` åˆ°ç¼–è¯‘åˆ—è¡¨

### å®¢æˆ·ç«¯

1. **`magic_client/cli_interface.h/.c`**
   - æ·»åŠ å…¨å±€ `SessionManager g_session_manager`
   - æä¾› `cli_get_session_manager()` è®¿é—®æ¥å£

2. **`magic_client/magic_commands.c`**
   - **MCAR**: æ¯æ¬¡ç”Ÿæˆæ–° Session-Id,åˆ›å»ºæ–°ä¼šè¯
   - **MCCR create**: æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²è®¤è¯
   - **MCCR modify**: ä½¿ç”¨å½“å‰ Session-Id ä¿®æ”¹é“¾è·¯
   - **STR**: åˆ é™¤æŒ‡å®šä¼šè¯,è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–æ´»åŠ¨ä¼šè¯

3. **`magic_client/CMakeLists.txt`**
   - æ·»åŠ  `session_manager.c` åˆ°ç¼–è¯‘åˆ—è¡¨

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: åˆ›å»ºå¤šä¸ªå¹¶å‘é“¾è·¯

```bash
# ç»ˆç«¯1: å¯åŠ¨æœåŠ¡å™¨
cd build && freeDiameterd -c ../conf/magic_server.conf -dd

# ç»ˆç«¯2: å¯åŠ¨ DLM ç³»ç»Ÿ
./start_dlm_system.sh

# ç»ˆç«¯3: å®¢æˆ·ç«¯æ“ä½œ
./magic_client

# 1. åˆ›å»ºç¬¬ä¸€ä¸ªä¼šè¯ (è§†é¢‘æµ)
MAGIC[æœªæ³¨å†Œ]> mcar
  âœ“ Session created: magic-client.example.com;1732530001;12345678

MAGIC[å·²æ³¨å†Œ]> mccr create VIDEO_STREAMING 2048 5000 7 2
  âœ“ Link established on LINK_WIFI (Bearer 1)

# 2. åˆ›å»ºç¬¬äºŒä¸ªä¼šè¯ (æ•°æ®ä¼ è¾“)
MAGIC[å·²æ³¨å†Œ+é€šä¿¡ä¸­]> mcar
  âœ“ Session created: magic-client.example.com;1732530045;87654321
  Current sessions: 2/10

MAGIC[å·²æ³¨å†Œ+é€šä¿¡ä¸­]> mccr create IP_DATA 512 1024 5 0
  âœ“ Link established on LINK_CELLULAR (Bearer 2)

# 3. æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
MAGIC[å·²æ³¨å†Œ+é€šä¿¡ä¸­]> sessions

========================================
  Active Sessions (2/10)
========================================

[1] Session-Id: magic-client.example.com;1732530001;12345678
    State: ACTIVE
    Link: LINK_WIFI (Bearer 1)
    Bandwidth: 2048/512 kbps
    Created: 44 seconds ago

[2] Session-Id: magic-client.example.com;1732530045;87654321
    State: ACTIVE
    Link: LINK_CELLULAR (Bearer 2)
    Bandwidth: 512/256 kbps
    Created: 0 seconds ago

  Current Session: magic-client.example.com;1732530045;87654321
========================================

# 4. åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªä¼šè¯
MAGIC[å·²æ³¨å†Œ+é€šä¿¡ä¸­]> switch magic-client.example.com;1732530001;12345678
  âœ“ Switched to session

# 5. ä¿®æ”¹ç¬¬ä¸€ä¸ªä¼šè¯çš„å¸¦å®½
MAGIC[å·²æ³¨å†Œ+é€šä¿¡ä¸­]> mccr modify 4096 10000 8 2
  âœ“ Link modified (4096/1024 kbps)

# 6. ç»ˆæ­¢ç¬¬äºŒä¸ªä¼šè¯
MAGIC[å·²æ³¨å†Œ+é€šä¿¡ä¸­]> str magic-client.example.com;1732530045;87654321
  âœ“ Session terminated (Bearer 2 released)
  Active sessions: 1/10
```

### åœºæ™¯2: å¹¶å‘ä¸šåŠ¡æµ

```
å®¢æˆ·ç«¯å¯ä»¥åŒæ—¶ç»´æŠ¤:
- ä¼šè¯1: é«˜æ¸…è§†é¢‘æµ (LINK_WIFI, 5 Mbps)
- ä¼šè¯2: å®æ—¶é¥æµ‹æ•°æ® (LINK_CELLULAR, 512 kbps)
- ä¼šè¯3: åå°æ–‡ä»¶ä¼ è¾“ (LINK_SATCOM, 1 Mbps)

æ¯ä¸ªä¼šè¯ç‹¬ç«‹ç®¡ç†,äº’ä¸å½±å“!
```

## ğŸ“Š æœåŠ¡å™¨ç«¯ä¼šè¯è·Ÿè¸ª

æœåŠ¡å™¨æ—¥å¿—ç¤ºä¾‹:

```
17:05:23  NOTI   [app_magic] âœ“ Session created: magic-client...;001 (client: magic-client.example.com)
17:05:25  NOTI   [app_magic] âœ“ Session assigned: magic-client.example.com â†’ LINK_WIFI (Bearer 1, 2048/512 kbps)

17:06:10  NOTI   [app_magic] âœ“ Session created: magic-client...;002 (client: magic-client.example.com)
17:06:12  NOTI   [app_magic] âœ“ Session assigned: magic-client.example.com â†’ LINK_CELLULAR (Bearer 2, 512/256 kbps)

17:06:50  NOTI   [app_magic] Session deleted: magic-client...;002 (client: magic-client.example.com)
17:06:50  NOTI   [app_magic] Releasing link resources: magic-client.example.com (Bearer 2 on LINK_CELLULAR)
```

## âš™ï¸ é…ç½®é™åˆ¶

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| æœåŠ¡å™¨æœ€å¤§ä¼šè¯æ•° | 100 | `MAX_SESSIONS` in magic_session.h |
| å®¢æˆ·ç«¯æœ€å¤§ä¼šè¯æ•° | 10 | `MAX_CLIENT_SESSIONS` in session_manager.h |
| Session-Id é•¿åº¦ | 128 | `MAX_SESSION_ID_LEN` |

## ğŸ”’ çº¿ç¨‹å®‰å…¨

- æœåŠ¡å™¨ç«¯: ä½¿ç”¨ `pthread_mutex` ä¿æŠ¤ä¼šè¯è¡¨
- å®¢æˆ·ç«¯: ä½¿ç”¨ `pthread_mutex` ä¿æŠ¤ä¼šè¯ç®¡ç†å™¨
- æ‰€æœ‰è®¿é—®å‡½æ•°éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

## âœ… ç¬¦åˆ ARINC 839 æ ‡å‡†

- âœ… æ”¯æŒå¤šä¼šè¯å¹¶å‘ (Section 3.2.1)
- âœ… Session-Id å”¯ä¸€æ€§ä¿è¯
- âœ… æ¯ä¸ªä¼šè¯ç‹¬ç«‹çš„é“¾è·¯åˆ†é…
- âœ… èµ„æºéš”ç¦»å’Œç‹¬ç«‹ç®¡ç†
- âœ… ä¼šè¯ç”Ÿå‘½å‘¨æœŸå®Œæ•´ç®¡ç†

## ğŸ“ æŠ€æœ¯è¦ç‚¹

1. **Session-Id ç”Ÿæˆ**
   ```
   æ ¼å¼: <Origin-Host>;<timestamp>;<random>
   ç¤ºä¾‹: magic-client.example.com;1732530001;A1B2C3D4
   ```

2. **ä¼šè¯çŠ¶æ€æœº**
   ```
   IDLE â†’ AUTHENTICATING â†’ AUTHENTICATED â†’ 
   ESTABLISHING â†’ ACTIVE â†’ MODIFYING â†’ TERMINATING â†’ IDLE
   ```

3. **Bearer åˆ†é…**
   - æ¯ä¸ªä¼šè¯ç‹¬ç«‹ç”³è¯· Bearer-ID
   - åŒä¸€å®¢æˆ·ç«¯å¯ä»¥æœ‰å¤šä¸ª Bearer
   - DLM è´Ÿè´£ Bearer èµ„æºç®¡ç†

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `MIH_PROTOCOL_REVIEW.md` - MIH åè®®åˆè§„æ€§å®¡æŸ¥
- `ARCHITECTURE_SUMMARY.md` - ç³»ç»Ÿæ¶æ„æ€»ç»“
- `ARINC_839_Flow_Diagram.md` - å®Œæ•´æµç¨‹å›¾

