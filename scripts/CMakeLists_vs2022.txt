# CMakeLists.txt for freeDiameter Client - Visual Studio 2022 Optimized
cmake_minimum_required(VERSION 3.16)
project(freeDiameterClient VERSION 1.0.0 LANGUAGES C)

# Set C standard
set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)

# Visual Studio 2022 specific settings
if(MSVC)
    # Use Visual Studio 2022 toolset
    set(CMAKE_GENERATOR_TOOLSET "v143")
    
    # Enable parallel compilation
    add_compile_options(/MP)
    
    # Disable specific warnings for Windows
    add_compile_definitions(_CRT_SECURE_NO_WARNINGS)
    add_compile_definitions(_WINSOCK_DEPRECATED_NO_WARNINGS)
    
    # Set runtime library to MultiThreaded DLL
    set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>DLL")
    
    # Enable debug information in Release builds
    set(CMAKE_C_FLAGS_RELEASE "${CMAKE_C_FLAGS_RELEASE} /Zi")
    set(CMAKE_EXE_LINKER_FLAGS_RELEASE "${CMAKE_EXE_LINKER_FLAGS_RELEASE} /DEBUG /OPT:REF /OPT:ICF")
endif()

# Windows specific definitions
if(WIN32)
    add_compile_definitions(WIN32_LEAN_AND_MEAN)
    add_compile_definitions(NOMINMAX)
    add_compile_definitions(_WIN32_WINNT=0x0601)  # Windows 7 and later
endif()

# Include directories
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/libfdproto)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/libfdcore)

# Find required libraries for Windows
if(WIN32)
    # Find Windows Socket library
    find_library(WS2_32_LIBRARY ws2_32)
    find_library(WSOCK32_LIBRARY wsock32)
    find_library(IPHLPAPI_LIBRARY iphlpapi)
    find_library(CRYPT32_LIBRARY crypt32)
    
    if(NOT WS2_32_LIBRARY)
        message(FATAL_ERROR "ws2_32 library not found")
    endif()
endif()

# libfdproto source files
set(LIBFDPROTO_SOURCES
    src/libfdproto/fifo.c
    src/libfdproto/init.c
    src/libfdproto/lists.c
    src/libfdproto/log.c
    src/libfdproto/ostr.c
    src/libfdproto/rt_data.c
    src/libfdproto/utils.c
    src/libfdproto/version.c
)

# libfdcore source files
set(LIBFDCORE_SOURCES
    src/libfdcore/apps.c
    src/libfdcore/cnxctx.c
    src/libfdcore/config.c
    src/libfdcore/core.c
    src/libfdcore/events.c
    src/libfdcore/hooks.c
    src/libfdcore/messages.c
    src/libfdcore/p_ce.c
    src/libfdcore/p_cnx.c
    src/libfdcore/p_dp.c
    src/libfdcore/p_dw.c
    src/libfdcore/p_expiry.c
    src/libfdcore/p_out.c
    src/libfdcore/p_psm.c
    src/libfdcore/p_sr.c
    src/libfdcore/peers.c
    src/libfdcore/queues.c
    src/libfdcore/server.c
    src/libfdcore/tcp.c
    src/libfdcore/version.c
)

# Client source files
set(CLIENT_SOURCES
    src/diameter_client/main.c
    src/diameter_client/cli.c
    src/diameter_client/auth_manager.c
    src/diameter_client/client_core.c
    src/diameter_client/message_handler.c
    src/diameter_client/config_parser.c
    src/diameter_client/utils.c
)

# Build libfdproto as static library
add_library(fdproto STATIC ${LIBFDPROTO_SOURCES})

# Build libfdcore as static library
add_library(fdcore STATIC ${LIBFDCORE_SOURCES})
target_link_libraries(fdcore fdproto)

# Build diameter_client executable
add_executable(diameter_client ${CLIENT_SOURCES})

# Link libraries
if(WIN32)
    target_link_libraries(diameter_client 
        fdcore 
        fdproto 
        ${WS2_32_LIBRARY}
        ${WSOCK32_LIBRARY}
        ${IPHLPAPI_LIBRARY}
        ${CRYPT32_LIBRARY}
    )
else()
    target_link_libraries(diameter_client 
        fdcore 
        fdproto 
        pthread 
        m
    )
endif()

# Compiler specific options
if(MSVC)
    # Visual Studio specific compile options
    target_compile_options(diameter_client PRIVATE 
        /W3          # Warning level 3
        /WX-         # Don't treat warnings as errors
        /wd4996      # Disable deprecated function warnings
        /wd4267      # Disable size_t conversion warnings
        /wd4244      # Disable conversion warnings
    )
    
    # Set subsystem to console
    set_target_properties(diameter_client PROPERTIES
        LINK_FLAGS "/SUBSYSTEM:CONSOLE"
    )
else()
    # GCC/Clang options
    target_compile_options(diameter_client PRIVATE 
        -Wall 
        -Wextra 
        -Wno-unused-parameter
        -Wno-deprecated-declarations
    )
endif()

# Set output directory
set_target_properties(diameter_client PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/Release
    RUNTIME_OUTPUT_DIRECTORY_DEBUG ${CMAKE_BINARY_DIR}/Debug
    RUNTIME_OUTPUT_DIRECTORY_RELEASE ${CMAKE_BINARY_DIR}/Release
)

# Install rules
install(TARGETS diameter_client
    RUNTIME DESTINATION bin
)

# Install configuration files
install(FILES 
    config/client.conf
    config/minimal_test.conf
    DESTINATION etc
    OPTIONAL
)

# Install certificates
install(FILES 
    certs/ca.crt
    certs/client.crt
    certs/client.key
    DESTINATION certs
    OPTIONAL
)

# Print build information
message(STATUS "===========================================")
message(STATUS "freeDiameter Client Build Configuration")
message(STATUS "===========================================")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C Compiler: ${CMAKE_C_COMPILER}")
message(STATUS "C Standard: ${CMAKE_C_STANDARD}")
if(MSVC)
    message(STATUS "MSVC Version: ${MSVC_VERSION}")
    message(STATUS "Toolset: ${CMAKE_GENERATOR_TOOLSET}")
endif()
message(STATUS "Target Platform: ${CMAKE_SYSTEM_NAME}")
message(STATUS "Target Architecture: ${CMAKE_SYSTEM_PROCESSOR}")
message(STATUS "===========================================")