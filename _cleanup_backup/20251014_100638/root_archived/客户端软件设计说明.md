# freeDiameter 航空通信客户端软件设计说明

## 1. 项目概述

### 1.1 项目背景
freeDiameter 航空通信客户端是基于 Diameter 协议的航空通信系统客户端软件，专为航空环境下的多种客户端类型（乘客、机组、飞行员、维护、地面控制）提供可靠的通信服务。该客户端支持动态链路选择、智能带宽分配、环境感知和多种服务类型。

### 1.2 设计目标
- **多客户端类型支持**：支持乘客、机组、飞行员、维护和地面控制等不同类型的客户端
- **智能链路选择**：根据飞行阶段、位置信息和QoS需求自动选择最优通信链路
- **动态环境适应**：实时感知飞行环境变化，动态调整通信策略
- **高可靠性**：提供多级备用链路和故障恢复机制
- **安全认证**：完整的身份认证和会话管理机制
- **用户友好**：提供直观的命令行界面和丰富的状态信息

### 1.3 核心特性
- 基于 Diameter 协议的标准化通信
- 支持卫星、地面等多种通信链路
- 实时环境监测和链路优化
- 分层优先级和带宽管理
- 完整的日志记录和调试支持
- 模块化设计，易于扩展和维护

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    客户端应用层                              │
├─────────────────────────────────────────────────────────────┤
│  命令行界面 (CLI)  │  认证管理器  │  链路选择器  │  消息生成器  │
├─────────────────────────────────────────────────────────────┤
│              Diameter 核心模块 (diameter_core)              │
├─────────────────────────────────────────────────────────────┤
│  响应处理器  │  IP欺骗器  │  日志模块  │  配置管理  │  工具模块  │
├─────────────────────────────────────────────────────────────┤
│                  freeDiameter 协议栈                        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块关系图
```
main.c (主程序)
├── logging.c (日志系统)
├── diameter_core.c (Diameter核心)
│   ├── auth_manager.c (认证管理)
│   ├── link_selector.c (链路选择)
│   ├── message_generator.c (消息生成)
│   └── response_handler.c (响应处理)
├── cli.c (命令行界面)
│   ├── ip_spoofer.c (IP欺骗)
│   └── 各种命令处理函数
└── 配置文件 (client.conf)
```

### 2.3 数据流向
1. **启动流程**：main.c → 日志初始化 → Diameter核心初始化 → 认证管理器初始化 → 链路选择器初始化
2. **认证流程**：CLI命令 → 认证管理器 → 消息生成器 → Diameter核心 → 服务端
3. **链路选择**：环境更新 → 链路选择器 → 消息生成器 → Diameter核心 → 服务端
4. **消息处理**：服务端响应 → Diameter核心 → 响应处理器 → 状态更新

## 3. 核心模块设计

### 3.1 主程序模块 (main.c)
**功能描述**：客户端程序的入口点，负责系统初始化和主要组件的启动。

**主要功能**：
- 信号处理设置（SIGINT, SIGTERM）
- 日志系统初始化
- Diameter 核心模块初始化
- 认证管理器初始化
- 链路选择器初始化
- 自动登录测试
- 命令行界面启动

**关键代码结构**：
```c
int main(int argc, char **argv) {
    // 信号处理设置
    signal(SIGINT, signal_handler);
    signal(SIGTERM, signal_handler);
    
    // 初始化各个模块
    logging_init();
    diameter_init("client.conf", 100000);
    auth_manager_init(...);
    link_selector_init();
    
    // 启动CLI
    run_cli();
}
```

### 3.2 Diameter 核心模块 (diameter_core.c/.h)
**功能描述**：封装 freeDiameter 协议栈，提供消息发送和接收的核心功能。

**主要功能**：
- Diameter 协议栈初始化和配置
- 同步和异步消息发送
- 消息回调处理
- 连接状态管理
- 协议栈清理

**关键接口**：
```c
int diameter_init(const char *config_file, uint32_t application_id);
int diameter_send_message_sync(struct msg *msg, struct msg **answer);
int diameter_send_message(struct msg *msg);
void diameter_fini(void);
```

### 3.3 认证管理器 (auth_manager.c/.h)
**功能描述**：管理客户端的身份认证、会话状态和权限控制。

**主要功能**：
- 客户端身份认证
- 会话状态管理
- 认证信息维护
- 会话超时检测
- 多种客户端类型支持

**数据结构**：
```c
typedef enum {
    AUTH_STATE_DISCONNECTED,
    AUTH_STATE_CONNECTING,
    AUTH_STATE_AUTHENTICATING,
    AUTH_STATE_AUTHENTICATED,
    AUTH_STATE_FAILED
} auth_state_t;

typedef enum {
    CLIENT_TYPE_PASSENGER = 1,
    CLIENT_TYPE_CREW = 2,
    CLIENT_TYPE_PILOT = 3,
    CLIENT_TYPE_MAINTENANCE = 4,
    CLIENT_TYPE_GROUND_CONTROL = 5
} client_type_t;

typedef struct {
    char client_id[64];
    char credential[128];
    client_type_t client_type;
    priority_level_t priority;
    auth_state_t state;
    uint32_t session_timeout;
    uint32_t allocated_bandwidth;
    char session_id[128];
} client_auth_info_t;
```

**关键接口**：
```c
int auth_manager_init(const char *client_id, const char *credential, 
                     client_type_t client_type, priority_level_t priority);
int auth_manager_login(void);
int auth_manager_logout(void);
auth_state_t auth_manager_get_state(void);
bool auth_manager_is_session_expired(void);
```

### 3.4 链路选择器 (link_selector.c/.h)
**功能描述**：根据飞行环境、位置信息和QoS需求智能选择最优通信链路。

**主要功能**：
- 飞行阶段感知
- 位置信息处理
- QoS需求分析
- 链路质量评估
- 动态链路切换
- 环境更新处理

**数据结构**：
```c
typedef enum {
    FLIGHT_PHASE_GROUND = 1,
    FLIGHT_PHASE_TAKEOFF = 2,
    FLIGHT_PHASE_CLIMB = 3,
    FLIGHT_PHASE_CRUISE = 4,
    FLIGHT_PHASE_DESCENT = 5,
    FLIGHT_PHASE_APPROACH = 6,
    FLIGHT_PHASE_LANDING = 7
} flight_phase_t;

typedef struct {
    double latitude;
    double longitude;
    uint32_t altitude;
    uint32_t speed;
} location_info_t;

typedef struct {
    uint32_t min_bandwidth;
    uint32_t max_latency;
    uint32_t max_jitter;
    double min_reliability;
} qos_requirements_t;

typedef struct {
    char link_id[32];
    char link_type[32];
    uint32_t available_bandwidth;
    uint32_t latency;
    uint32_t jitter;
    double reliability;
    double signal_strength;
} link_info_t;
```

**关键接口**：
```c
int link_selector_init(void);
int link_selector_request(const link_selection_request_t *request, 
                         link_selection_response_t *response);
int link_selector_update_environment(const location_info_t *location, 
                                   flight_phase_t flight_phase);
```

### 3.5 消息生成器 (message_generator.c/.h)
**功能描述**：创建各种 Diameter 消息，包括认证、链路选择、环境更新等消息。

**主要功能**：
- MCAR (Mobile Client Authentication Request) 消息创建
- MADR (Mobile Application Data Request) 消息创建
- Link-Resource 消息创建
- IP-Traffic 消息创建
- Environment-Update-Request 消息创建

**关键接口**：
```c
struct msg *create_mcar_message(const char *credential);
struct msg *create_madr_message(uint32_t cdr_id);
struct msg *create_link_resource_message(const char *bearer_id, int bandwidth);
struct msg *create_ip_traffic_message(const char *src_ip, const char *dst_ip, const char *traffic_type);
```

### 3.6 响应处理器 (response_handler.c/.h)
**功能描述**：处理来自服务端的各种响应消息，更新客户端状态。

**主要功能**：
- 认证响应处理
- 链路选择响应处理
- 环境更新响应处理
- 错误处理和重试机制
- 状态同步

### 3.7 命令行界面 (cli.c/.h)
**功能描述**：提供用户交互界面，支持各种操作命令。

**支持命令**：
- `login` - 用户登录认证
- `logout` - 用户登出
- `status` - 查看连接状态
- `link-select` - 手动链路选择
- `env-update` - 环境信息更新
- `aircraft-status` - 飞机状态更新
- `send-mcar` - 发送认证请求
- `send-madr` - 发送数据请求
- `send-link-resource` - 发送链路资源请求
- `send-ip-traffic` - 发送IP流量请求
- `exit` - 退出程序

**关键接口**：
```c
void run_cli(void);
int execute_aircraft_status_update(double lat, double lon, uint32_t alt, uint32_t speed, int phase);
```

### 3.8 IP欺骗器 (ip_spoofer.c/.h)
**功能描述**：提供IP地址伪装功能，用于测试和特殊场景。

**主要功能**：
- IP地址伪装
- 数据包修改
- 网络接口管理

### 3.9 日志模块 (logging.c/.h)
**功能描述**：提供统一的日志记录功能，支持多级别日志输出。

**主要功能**：
- 多级别日志（DEBUG, INFO, WARN, ERROR）
- 日志文件管理
- 线程安全的日志记录
- 日志格式化

## 4. 接口设计和数据结构

### 4.1 主要数据结构

#### 4.1.1 客户端认证信息
```c
typedef struct {
    char client_id[64];           // 客户端ID
    char credential[128];         // 认证凭证
    client_type_t client_type;    // 客户端类型
    priority_level_t priority;    // 优先级
    char service_requirements[256]; // 服务需求
    auth_state_t state;           // 当前认证状态
    uint32_t session_timeout;     // 会话超时时间
    uint32_t allocated_bandwidth; // 分配的带宽
    char session_id[128];         // 会话ID
    time_t last_auth_time;        // 最后认证时间
    time_t session_start_time;    // 会话开始时间
} client_auth_info_t;
```

#### 4.1.2 链路选择请求
```c
typedef struct {
    char client_id[64];           // 客户端ID
    location_info_t location;     // 当前位置
    flight_phase_t flight_phase;  // 飞行阶段
    uint32_t bandwidth_req;       // 带宽需求
    qos_requirements_t qos;       // QoS需求
    service_type_t service_type;  // 服务类型
} link_selection_request_t;
```

#### 4.1.3 链路选择响应
```c
typedef struct {
    uint32_t result_code;         // 结果代码
    link_info_t recommended_link; // 推荐链路
    link_info_t backup_links[3];  // 备用链路 (最多3个)
    int backup_count;             // 备用链路数量
    uint32_t allocated_bandwidth; // 分配的带宽
    char route_info[256];         // 路由信息
} link_selection_response_t;
```

### 4.2 核心接口

#### 4.2.1 Diameter 核心接口
```c
// 初始化 Diameter 核心
int diameter_init(const char *config_file, uint32_t application_id);

// 同步发送消息
int diameter_send_message_sync(struct msg *msg, struct msg **answer);

// 异步发送消息
int diameter_send_message(struct msg *msg);

// 清理 Diameter 核心
void diameter_fini(void);
```

#### 4.2.2 认证管理接口
```c
// 初始化认证管理器
int auth_manager_init(const char *client_id, const char *credential, 
                     client_type_t client_type, priority_level_t priority);

// 执行登录
int auth_manager_login(void);

// 执行登出
int auth_manager_logout(void);

// 获取认证状态
auth_state_t auth_manager_get_state(void);

// 获取认证信息
const client_auth_info_t* auth_manager_get_info(void);

// 刷新会话
int auth_manager_refresh_session(void);

// 检查会话是否过期
bool auth_manager_is_session_expired(void);
```

#### 4.2.3 链路选择接口
```c
// 初始化链路选择器
int link_selector_init(void);

// 请求链路选择
int link_selector_request(const link_selection_request_t *request, 
                         link_selection_response_t *response);

// 更新环境信息
int link_selector_update_environment(const location_info_t *location, 
                                   flight_phase_t flight_phase);

// 创建链路选择请求消息
struct msg* create_link_selection_request(const link_selection_request_t *request);

// 处理链路选择响应
int handle_link_selection_response(struct msg *msg, link_selection_response_t *response);
```

## 5. 配置管理和部署说明

### 5.1 配置文件结构
客户端使用 `client.conf` 配置文件，主要配置项包括：

```conf
# Diameter 协议配置
Identity = "client.example.com";
Realm = "example.com";
Port = 3868;
SecPort = 3869;

# 服务端连接配置
ConnectPeer = "server.example.com" { ConnectTo = "192.168.1.100"; Port = 3868; };

# 应用程序配置
LoadExtension = "app_client.so";

# 日志配置
LogLevel = 2;
LogFile = "/var/log/diameter_client.log";

# 客户端特定配置
ClientType = "PASSENGER";
Priority = "NORMAL";
DefaultBandwidth = 1024;
```

### 5.2 编译和构建

#### 5.2.1 依赖项
- freeDiameter 库
- CMake 3.10+
- GCC 7.0+
- pthread 库

#### 5.2.2 编译步骤
```bash
# 进入客户端目录
cd diameter_client

# 创建构建目录
mkdir build && cd build

# 配置和编译
cmake ..
make

# 安装（可选）
sudo make install
```

### 5.3 部署配置

#### 5.3.1 系统要求
- Linux 操作系统
- 最小内存：512MB
- 磁盘空间：100MB
- 网络连接：支持TCP/IP

#### 5.3.2 运行环境设置
```bash
# 设置环境变量
export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

# 创建日志目录
sudo mkdir -p /var/log/diameter_client
sudo chown $USER:$USER /var/log/diameter_client

# 设置配置文件权限
chmod 644 client.conf
```

#### 5.3.3 启动客户端
```bash
# 直接启动
./diameter_client

# 后台启动
nohup ./diameter_client > /dev/null 2>&1 &

# 使用特定配置文件
./diameter_client -c /path/to/custom.conf
```

## 6. 使用指南

### 6.1 基本操作流程

#### 6.1.1 启动和登录
```bash
# 启动客户端
./diameter_client

# 在CLI中执行登录
> login

# 查看连接状态
> status
```

#### 6.1.2 链路选择操作
```bash
# 更新环境信息
> env-update

# 手动链路选择
> link-select

# 更新飞机状态
> aircraft-status 39.9042 116.4074 10000 800 4
```

#### 6.1.3 消息发送操作
```bash
# 发送认证请求
> send-mcar

# 发送数据请求
> send-madr 12345

# 发送链路资源请求
> send-link-resource bearer_001 2048

# 发送IP流量请求
> send-ip-traffic 192.168.1.100 10.0.0.1 DATA
```

### 6.2 故障排除

#### 6.2.1 常见问题
1. **连接失败**：检查网络连接和服务端状态
2. **认证失败**：验证客户端凭证和配置
3. **消息发送失败**：检查 Diameter 协议栈状态
4. **链路选择失败**：确认环境信息和QoS需求

#### 6.2.2 调试方法
```bash
# 启用详细日志
export DIAMETER_LOG_LEVEL=DEBUG

# 查看日志文件
tail -f /var/log/diameter_client.log

# 使用调试工具
gdb ./diameter_client
```

## 7. 扩展开发指南

### 7.1 添加新的消息类型
1. 在 `message_generator.h` 中声明新的消息创建函数
2. 在 `message_generator.c` 中实现消息创建逻辑
3. 在 `response_handler.h` 中声明响应处理函数
4. 在 `response_handler.c` 中实现响应处理逻辑
5. 在 `cli.c` 中添加相应的命令支持

### 7.2 添加新的客户端类型
1. 在 `auth_manager.h` 中扩展 `client_type_t` 枚举
2. 更新认证逻辑以支持新的客户端类型
3. 修改配置文件解析逻辑
4. 更新相关的消息处理函数

### 7.3 扩展链路选择算法
1. 在 `link_selector.c` 中实现新的选择算法
2. 添加新的QoS参数和评估指标
3. 更新链路信息数据结构
4. 实现算法配置接口

## 8. 性能优化和调优

### 8.1 内存优化
- 使用内存池管理频繁分配的对象
- 及时释放不再使用的消息对象
- 优化数据结构大小和对齐

### 8.2 网络优化
- 实现消息批处理机制
- 使用连接复用减少建连开销
- 优化消息序列化和反序列化

### 8.3 并发优化
- 使用线程池处理并发请求
- 实现无锁数据结构
- 优化锁的粒度和持有时间

## 9. 安全特性

### 9.1 身份认证
- 支持多种认证机制
- 实现会话管理和超时控制
- 提供认证状态监控

### 9.2 数据保护
- 支持TLS/DTLS加密传输
- 实现消息完整性校验
- 提供敏感数据保护机制

### 9.3 访问控制
- 基于客户端类型的权限控制
- 实现优先级管理
- 提供审计日志功能

## 10. 总结

freeDiameter 航空通信客户端是一个功能完整、架构清晰的通信软件，具有以下特点：

1. **模块化设计**：各模块职责明确，接口清晰，易于维护和扩展
2. **智能化功能**：支持智能链路选择和环境自适应
3. **多样化支持**：支持多种客户端类型和服务需求
4. **高可靠性**：提供完整的错误处理和恢复机制
5. **用户友好**：提供直观的命令行界面和丰富的状态信息
6. **标准化协议**：基于 Diameter 协议，确保互操作性
7. **安全可靠**：实现完整的认证和加密机制

该客户端软件为航空通信环境提供了可靠、高效、智能的通信解决方案，能够满足不同场景下的通信需求。