# freeDiameter 客户端部署指南

## 概述

本指南说明如何将 freeDiameter 客户端部署到其他计算机上运行。经过路径修正后，客户端现在支持在不同路径下的可移植部署。

## 部署包结构

需要部署的主要目录包括：

### 1. diameter_client 目录
```
diameter_client/
├── diameter_client          # 主要的客户端可执行文件
├── *.conf                   # 各种配置文件
├── *.crt, *.key            # TLS证书和密钥文件
├── libfdcore.so*           # 核心库文件
├── libfdproto.so*          # 协议库文件
└── 其他支持文件
```

### 2. exe 目录
```
exe/
├── diameter_client          # 客户端可执行文件
├── conf/                   # 配置文件目录
│   └── *.conf
├── client_conf/            # 客户端专用配置
│   └── *.conf
├── certs/                  # 证书文件目录
│   ├── client.crt
│   ├── client.key
│   └── ca.crt
├── *.fdx                   # 扩展文件
├── *.so*                   # 共享库文件
└── start_client.sh         # 启动脚本
```

### 3. build 目录（必需的扩展文件）
```
build/
└── extensions/
    ├── dict_arinc839.fdx   # ARINC-839字典扩展
    └── 其他扩展文件
```

## 部署步骤

### 步骤1：复制文件
将以下目录复制到目标计算机：
```bash
# 复制主要目录
cp -r diameter_client /path/to/target/
cp -r exe /path/to/target/
cp -r build /path/to/target/
```

### 步骤2：设置权限
```bash
# 设置可执行文件权限
chmod +x /path/to/target/diameter_client/diameter_client
chmod +x /path/to/target/exe/diameter_client
chmod +x /path/to/target/exe/start_client.sh

# 设置库文件权限
chmod +x /path/to/target/diameter_client/*.so*
chmod +x /path/to/target/exe/*.so*

# 保护私钥文件
chmod 600 /path/to/target/diameter_client/*.key
chmod 600 /path/to/target/exe/certs/*.key
```

### 步骤3：配置环境变量
```bash
# 设置库路径（可选，如果系统找不到共享库）
export LD_LIBRARY_PATH=/path/to/target/diameter_client:/path/to/target/exe:$LD_LIBRARY_PATH
```

## 运行方式

### 方式1：使用 diameter_client 目录
```bash
cd /path/to/target/diameter_client
./diameter_client minimal_test.conf
```

### 方式2：使用 exe 目录
```bash
cd /path/to/target/exe
./start_client.sh
```

或者直接运行：
```bash
cd /path/to/target/exe
./diameter_client conf/minimal_test.conf
```

## 配置文件说明

### 主要配置文件

1. **minimal_test.conf** - 最小化测试配置
2. **client.conf** - 标准客户端配置
3. **client_tls.conf** - TLS加密配置

### 关键配置项

#### 网络配置
```
Identity = "client.example.com";    # 客户端标识
Realm = "example.com";              # 域名
Port = 3869;                        # 监听端口
SecPort = 5869;                     # TLS端口
```

#### TLS配置
```
TLS_Cred = "client.crt", "client.key";  # 客户端证书和私钥
TLS_CA = "ca.crt";                       # CA证书
```

#### 扩展加载
```
LoadExtension = "dict_arinc839.fdx";     # ARINC-839字典
```

#### 服务器连接
```
ConnectPeer = "server.example.com" { ConnectTo = "192.168.37.136"; Port = 5868; };
```

## 故障排除

### 常见问题

1. **找不到共享库**
   ```
   错误：error while loading shared libraries: libfdcore.so.7
   解决：设置 LD_LIBRARY_PATH 或将库文件复制到系统库目录
   ```

2. **找不到证书文件**
   ```
   错误：Unable to load certificate file
   解决：检查证书文件路径和权限
   ```

3. **找不到扩展文件**
   ```
   错误：Unable to load extension
   解决：确保 build/extensions/ 目录存在且包含所需的 .fdx 文件
   ```

4. **端口冲突**
   ```
   错误：Address already in use
   解决：修改配置文件中的 Port 和 SecPort 设置
   ```

### 调试方法

1. **启用详细日志**
   ```bash
   ./diameter_client -v config.conf
   ```

2. **检查配置文件语法**
   ```bash
   ./diameter_client -c config.conf
   ```

3. **查看运行时日志**
   ```bash
   tail -f diameter_client.log
   ```

## 网络配置

### 防火墙设置
确保以下端口开放：
- 客户端监听端口（默认3869）
- TLS端口（默认5869）
- 服务器连接端口（默认5868）

### 服务器地址配置
修改配置文件中的服务器地址：
```
ConnectPeer = "your-server.domain.com" { 
    ConnectTo = "服务器IP地址"; 
    Port = 5868; 
};
```

## 安全注意事项

1. **证书管理**
   - 确保私钥文件权限为600
   - 定期更新证书
   - 使用强密码保护私钥

2. **网络安全**
   - 使用TLS加密连接
   - 限制网络访问权限
   - 监控连接日志

3. **文件权限**
   - 可执行文件：755
   - 配置文件：644
   - 私钥文件：600
   - 证书文件：644

## 性能优化

1. **线程配置**
   ```
   AppServThreads = 4;  # 根据CPU核心数调整
   ```

2. **缓冲区设置**
   ```
   # 在配置文件中调整缓冲区大小
   ```

3. **日志级别**
   ```
   # 生产环境建议使用较低的日志级别
   ```

## 版本兼容性

- 支持的操作系统：Linux (Ubuntu, CentOS, RHEL)
- 依赖库版本：
  - glibc >= 2.17
  - openssl >= 1.0.2
  - 其他依赖见原始构建环境

## 联系支持

如遇到部署问题，请提供：
1. 操作系统版本
2. 错误日志
3. 配置文件内容
4. 网络环境信息

---

**注意：本指南基于已修正硬编码路径的版本，确保使用最新的配置文件。**