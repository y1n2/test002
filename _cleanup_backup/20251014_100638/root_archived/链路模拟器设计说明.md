# freeDiameter 链路模拟器设计说明

## 1. 项目概述

### 1.1 背景介绍

链路模拟器是 freeDiameter 航空通信系统的重要组成部分，专门用于模拟不同类型的网络链路环境。在航空通信场景中，飞机需要在不同的飞行阶段使用不同类型的通信链路，包括地面以太网、机场WiFi、空中蜂窝网络和卫星通信等。链路模拟器通过仿真这些不同链路的特性，为系统测试、性能评估和链路选择算法验证提供了重要的测试环境。

### 1.2 设计目标

- **多链路类型支持**：支持以太网、WiFi、蜂窝和卫星四种主要链路类型
- **真实性仿真**：准确模拟各种链路的带宽、延迟、丢包率和可靠性特征
- **协议兼容性**：完全兼容 Diameter 协议，支持标准的 Diameter 消息交换
- **高并发处理**：支持多客户端同时连接，模拟真实的多用户环境
- **动态链路管理**：支持链路状态的动态变化和连接质量监控
- **可扩展性**：模块化设计，便于添加新的链路类型和仿真参数

### 1.3 核心特性

- **链路特性仿真**：精确模拟不同链路的物理特性和网络行为
- **连接管理**：智能的连接管理和重连机制
- **协议处理**：完整的 Diameter 协议栈实现
- **性能监控**：实时的链路质量监控和统计信息收集
- **测试支持**：提供完整的测试工具和验证机制

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    链路模拟器系统                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 以太网模拟器  │  │  WiFi模拟器  │  │  蜂窝模拟器  │         │
│  │   :8001     │  │   :8002     │  │   :8003     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  卫星模拟器  │  │  连接管理器  │  │  协议处理器  │         │
│  │   :8004     │  │             │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    核心服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 链路协议栈   │  │ 消息处理器   │  │ 统计监控器   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    基础设施层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  网络I/O    │  │  线程管理    │  │  内存管理    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块关系图

```
客户端应用
    │
    ├── 以太网链路 ──┐
    ├── WiFi链路 ───┤
    ├── 蜂窝链路 ───┼── 链路模拟器
    └── 卫星链路 ───┘
                    │
                    ├── 连接管理器
                    ├── 协议处理器
                    ├── 消息生成器
                    ├── 统计监控器
                    └── 配置管理器
```

### 2.3 数据流向

1. **连接建立**：客户端连接到指定端口的链路模拟器
2. **协议协商**：进行 Diameter 能力交换和设备监控
3. **消息处理**：处理各种 Diameter 消息（MCAR、MADR等）
4. **链路仿真**：应用链路特性（延迟、丢包、带宽限制）
5. **响应返回**：生成并返回相应的 Diameter 响应消息
6. **状态监控**：持续监控连接状态和链路质量

## 3. 核心模块设计

### 3.1 主程序模块 (main.c)

**功能职责**：
- 系统初始化和配置加载
- 多线程服务器启动
- 信号处理和优雅关闭
- 全局资源管理

**核心实现**：
```c
// 链路参数初始化
struct sim_link_params {
    link_type_t type;
    int port;
    float bandwidth_mbps;
    float latency_ms;
    float packet_loss_rate;
    int reliability;
};

// 客户端连接信息
struct client_info {
    int socket_fd;
    struct sockaddr_in address;
    link_type_t link_type;
    int active;
    pthread_t thread_id;
    uint32_t hop_by_hop_id;
    uint32_t end_to_end_id;
    char peer_host[256];
    char peer_realm[256];
    int capabilities_exchanged;
};
```

### 3.2 Diameter 协议处理器

**功能职责**：
- Diameter 消息解析和生成
- 协议栈实现（CER/CEA、DWR/DWA等）
- AVP 处理和验证
- 消息路由和转发

**支持的消息类型**：
- **Capabilities-Exchange-Request/Answer (CER/CEA)**：能力交换
- **Device-Watchdog-Request/Answer (DWR/DWA)**：设备监控
- **Disconnect-Peer-Request/Answer (DPR/DPA)**：断开连接
- **MADR (Mobile Aircraft Data Request)**：移动飞机数据请求

**核心数据结构**：
```c
// Diameter 消息头
typedef struct {
    uint8_t version;
    uint8_t length[3];
    uint8_t flags;
    uint8_t command_code[3];
    uint32_t application_id;
    uint32_t hop_by_hop_id;
    uint32_t end_to_end_id;
} diameter_header_t;

// AVP 头结构
typedef struct {
    uint32_t code;
    uint8_t flags;
    uint8_t length[3];
} avp_header_t;
```

### 3.3 链路仿真引擎

**功能职责**：
- 链路特性参数配置
- 网络延迟仿真
- 丢包率模拟
- 带宽限制实现

**链路类型配置**：

| 链路类型 | 端口 | 带宽(Mbps) | 延迟(ms) | 丢包率 | 可靠性 |
|---------|------|-----------|----------|--------|--------|
| 以太网   | 8001 | 1000      | 1        | 0.1%   | 99%    |
| WiFi    | 8002 | 100       | 5        | 1%     | 85%    |
| 蜂窝     | 8003 | 50        | 20       | 2%     | 80%    |
| 卫星     | 8004 | 10        | 500      | 5%     | 70%    |

**仿真算法**：
```c
// 丢包仿真
int simulate_packet_loss(float loss_rate) {
    return (rand() % 10000) < (loss_rate * 100);
}

// 延迟仿真
void simulate_latency(float latency_ms) {
    usleep((useconds_t)(latency_ms * 1000));
}
```

### 3.4 连接管理器 (connection_manager)

**功能职责**：
- 客户端连接生命周期管理
- 连接质量监控和评估
- 自动重连机制
- 连接健康状态跟踪

**连接状态管理**：
```c
typedef enum {
    RECONNECT_IMMEDIATE,    // 立即重连
    RECONNECT_LINEAR,       // 线性退避
    RECONNECT_EXPONENTIAL,  // 指数退避
    RECONNECT_DISABLED      // 禁用重连
} reconnect_strategy_t;

typedef enum {
    HEALTH_EXCELLENT,   // 优秀
    HEALTH_GOOD,        // 良好
    HEALTH_FAIR,        // 一般
    HEALTH_POOR,        // 较差
    HEALTH_CRITICAL     // 严重
} connection_health_t;
```

**重连配置**：
```c
struct reconnect_config {
    reconnect_strategy_t strategy;
    int max_attempts;
    int base_interval_sec;
    int max_interval_sec;
    float backoff_multiplier;
    int enabled;
};
```

### 3.5 链路协议栈 (link_protocol)

**功能职责**：
- 自定义链路协议实现
- 消息序列化和反序列化
- 路由请求和响应处理
- 链路状态管理

**协议消息类型**：
```c
typedef enum {
    LINK_MSG_ROUTE_REQUEST = 1,   // 路由请求
    LINK_MSG_ROUTE_RESPONSE = 2,  // 路由响应
    LINK_MSG_DATA_FORWARD = 3,    // 数据转发
    LINK_MSG_LINK_STATUS = 4,     // 链路状态
    LINK_MSG_ERROR = 5            // 错误消息
} link_msg_type_t;
```

**链路特性定义**：
```c
typedef struct {
    uint32_t delay_ms;           // 延迟(毫秒)
    uint32_t bandwidth_kbps;     // 带宽(kbps)
    uint8_t packet_loss_rate;    // 丢包率(百分比)
    uint32_t jitter_ms;          // 抖动(毫秒)
} link_characteristics_t;
```

### 3.6 统计监控模块

**功能职责**：
- 实时性能指标收集
- 链路质量统计
- 连接状态监控
- 诊断信息生成

**统计指标**：
```c
struct link_stats {
    uint32_t total_requests;      // 总请求数
    uint32_t successful_responses; // 成功响应数
    uint32_t failed_responses;    // 失败响应数
    uint32_t bytes_received;      // 接收字节数
    uint32_t bytes_sent;          // 发送字节数
};

struct connection_quality {
    uint32_t latency_ms;          // 延迟
    uint8_t packet_loss_rate;     // 丢包率
    uint32_t throughput_kbps;     // 吞吐量
    uint32_t error_count;         // 错误计数
};
```

### 3.7 测试工具模块

**功能职责**：
- 自动化测试脚本
- 连接测试工具
- 性能基准测试
- 协议兼容性验证

**测试类型**：
- **连接测试**：验证各链路类型的连接建立
- **协议测试**：验证 Diameter 协议消息交换
- **性能测试**：测试并发连接和消息处理能力
- **稳定性测试**：长时间运行和压力测试

## 4. 接口设计

### 4.1 网络接口

**TCP 服务端口**：
- 以太网模拟器：8001
- WiFi 模拟器：8002
- 蜂窝模拟器：8003
- 卫星模拟器：8004

**连接协议**：标准 TCP Socket 连接

### 4.2 Diameter 协议接口

**应用ID**：100000 (航空通信应用)

**支持的命令代码**：
- 257: Capabilities-Exchange
- 280: Device-Watchdog
- 282: Disconnect-Peer
- 100005: MADR (Mobile Aircraft Data Request)

**关键 AVP 代码**：
- 264: Origin-Host
- 296: Origin-Realm
- 268: Result-Code
- 258: Auth-Application-Id

### 4.3 管理接口

**连接管理 API**：
```c
int connection_manager_init(void);
int connection_manager_register_client(struct client_info* client, 
                                     struct reconnect_config* config);
void connection_manager_unregister_client(struct client_info* client);
connection_health_t connection_manager_get_health(struct client_info* client);
```

**链路协议 API**：
```c
link_route_request_t* link_create_route_request(uint32_t session_id, 
                                               uint32_t destination_id,
                                               uint8_t preferred_link, 
                                               uint8_t priority);
link_route_response_t* link_create_route_response(uint32_t session_id, 
                                                 uint32_t destination_id,
                                                 uint8_t selected_link, 
                                                 uint8_t result_code,
                                                 link_characteristics_t *characteristics);
```

## 5. 数据结构定义

### 5.1 核心数据结构

**链路类型枚举**：
```c
typedef enum {
    LINK_ETHERNET = 0,    // 以太网
    LINK_WIFI = 1,        // WiFi
    LINK_CELLULAR = 2,    // 蜂窝
    LINK_SATELLITE = 3,   // 卫星
    LINK_TYPE_COUNT = 4
} link_type_t;
```

**消息头结构**：
```c
typedef struct {
    uint32_t magic;           // 魔数标识
    uint8_t version;          // 协议版本
    uint8_t msg_type;         // 消息类型
    uint8_t flags;            // 标志位
    uint8_t reserved;         // 保留字段
    uint32_t length;          // 消息长度
    uint32_t session_id;      // 会话ID
} link_msg_header_t;
```

### 5.2 配置数据结构

**链路配置**：
```c
struct link_config {
    link_characteristics_t wifi;
    link_characteristics_t cellular;
    link_characteristics_t satellite;
    link_characteristics_t ethernet;
};
```

**服务器配置**：
```c
struct server_config {
    int max_clients;          // 最大客户端数
    int buffer_size;          // 缓冲区大小
    int thread_pool_size;     // 线程池大小
    int keepalive_interval;   // 心跳间隔
};
```

## 6. 配置管理

### 6.1 编译配置

**CMakeLists.txt 配置**：
```cmake
cmake_minimum_required(VERSION 3.10)
project(LinkSimulator)

set(CMAKE_C_STANDARD 99)
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Wextra -pthread")

# 源文件
set(SOURCES
    link_simulator.c
    connection_manager.c
    link_protocol.c
    diameter_link_simulator.c
)

# 可执行文件
add_executable(link_simulator ${SOURCES})
target_link_libraries(link_simulator pthread m)
```

**Makefile 配置**：
```makefile
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -pthread
LDFLAGS = -pthread -lm

SOURCES = link_simulator.c connection_manager.c link_protocol.c
TARGET = link_simulator

all: $(TARGET)

$(TARGET): $(SOURCES)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

clean:
	rm -f $(TARGET) *.o

run: $(TARGET)
	./$(TARGET)
```

### 6.2 运行时配置

**链路参数配置**：
```c
void init_link_params() {
    // 以太网配置
    link_params[LINK_ETHERNET] = (struct sim_link_params){
        .type = LINK_ETHERNET,
        .port = 8001,
        .bandwidth_mbps = 1000.0,
        .latency_ms = 1.0,
        .packet_loss_rate = 0.1,
        .reliability = 99
    };
    
    // WiFi配置
    link_params[LINK_WIFI] = (struct sim_link_params){
        .type = LINK_WIFI,
        .port = 8002,
        .bandwidth_mbps = 100.0,
        .latency_ms = 5.0,
        .packet_loss_rate = 1.0,
        .reliability = 85
    };
    
    // 蜂窝配置
    link_params[LINK_CELLULAR] = (struct sim_link_params){
        .type = LINK_CELLULAR,
        .port = 8003,
        .bandwidth_mbps = 50.0,
        .latency_ms = 20.0,
        .packet_loss_rate = 2.0,
        .reliability = 80
    };
    
    // 卫星配置
    link_params[LINK_SATELLITE] = (struct sim_link_params){
        .type = LINK_SATELLITE,
        .port = 8004,
        .bandwidth_mbps = 10.0,
        .latency_ms = 500.0,
        .packet_loss_rate = 5.0,
        .reliability = 70
    };
}
```

## 7. 部署说明

### 7.1 系统要求

**操作系统**：Linux (推荐 Ubuntu 18.04+)
**编译器**：GCC 7.0+ 
**依赖库**：
- pthread (POSIX 线程库)
- math (数学库)
- 标准 C 库

### 7.2 安装步骤

1. **获取源代码**：
```bash
cd /home/zhuwuhui/freeDiameter/link_simulator
```

2. **编译项目**：
```bash
make clean
make
```

3. **运行测试**：
```bash
make test
```

4. **启动服务**：
```bash
./link_simulator
```

### 7.3 服务管理

**启动服务**：
```bash
# 前台运行
./link_simulator

# 后台运行
nohup ./link_simulator > link_simulator.log 2>&1 &
```

**停止服务**：
```bash
# 发送 SIGTERM 信号
kill -TERM <pid>

# 或使用 Ctrl+C (前台运行时)
```

**查看状态**：
```bash
# 查看进程
ps aux | grep link_simulator

# 查看端口占用
netstat -tlnp | grep -E "800[1-4]"
```

## 8. 使用指南

### 8.1 基本使用

**启动链路模拟器**：
```bash
cd link_simulator
./link_simulator
```

**连接测试**：
```bash
# 测试 WiFi 链路 (端口 8002)
./test_link_simulator

# 或使用 telnet 测试
telnet localhost 8002
```

### 8.2 客户端集成

**配置客户端连接**：
```c
// 连接到 WiFi 链路模拟器
struct sockaddr_in server_addr;
server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(8002);
server_addr.sin_addr.s_addr = inet_addr("127.0.0.1");

int sock = socket(AF_INET, SOCK_STREAM, 0);
connect(sock, (struct sockaddr*)&server_addr, sizeof(server_addr));
```

### 8.3 监控和调试

**查看链路状态**：
- 链路模拟器启动时会显示各链路的配置信息
- 客户端连接时会显示连接状态和消息交换过程
- 支持实时的统计信息输出

**调试模式**：
```bash
# 编译调试版本
make debug

# 使用 GDB 调试
gdb ./link_simulator
```

## 9. 扩展开发

### 9.1 添加新链路类型

1. **扩展链路类型枚举**：
```c
typedef enum {
    LINK_ETHERNET = 0,
    LINK_WIFI = 1,
    LINK_CELLULAR = 2,
    LINK_SATELLITE = 3,
    LINK_5G = 4,          // 新增 5G 链路
    LINK_TYPE_COUNT = 5
} link_type_t;
```

2. **添加链路参数配置**：
```c
link_params[LINK_5G] = (struct sim_link_params){
    .type = LINK_5G,
    .port = 8005,
    .bandwidth_mbps = 1000.0,
    .latency_ms = 2.0,
    .packet_loss_rate = 0.5,
    .reliability = 95
};
```

### 9.2 自定义仿真算法

**扩展延迟模型**：
```c
void simulate_variable_latency(float base_latency, float jitter) {
    float actual_latency = base_latency + (rand() % 100 - 50) * jitter / 50.0;
    usleep((useconds_t)(actual_latency * 1000));
}
```

**扩展丢包模型**：
```c
int simulate_burst_packet_loss(float loss_rate, int burst_length) {
    static int burst_counter = 0;
    if (burst_counter > 0) {
        burst_counter--;
        return 1; // 丢包
    }
    
    if ((rand() % 10000) < (loss_rate * 100)) {
        burst_counter = burst_length - 1;
        return 1; // 开始突发丢包
    }
    return 0;
}
```

### 9.3 协议扩展

**添加新的 Diameter 命令**：
```c
#define CMD_CUSTOM_REQUEST 100010

int handle_custom_message(struct client_info* client, 
                         diameter_header_t* req_header,
                         char* avp_data, int avp_length) {
    // 自定义消息处理逻辑
    return 0;
}
```

## 10. 性能优化

### 10.1 并发优化

**线程池模式**：
```c
struct thread_pool {
    pthread_t* threads;
    int thread_count;
    pthread_mutex_t queue_mutex;
    pthread_cond_t queue_cond;
    struct task_queue* queue;
};
```

**异步I/O**：
- 使用 epoll 或 select 实现异步网络I/O
- 减少线程创建和销毁的开销
- 提高并发连接处理能力

### 10.2 内存优化

**内存池管理**：
```c
struct memory_pool {
    void* pool_start;
    size_t pool_size;
    size_t block_size;
    void* free_list;
    pthread_mutex_t pool_mutex;
};
```

**缓冲区复用**：
- 预分配固定大小的缓冲区
- 避免频繁的内存分配和释放
- 使用环形缓冲区提高效率

### 10.3 网络优化

**TCP 参数调优**：
```c
// 设置 TCP_NODELAY
int flag = 1;
setsockopt(sock, IPPROTO_TCP, TCP_NODELAY, &flag, sizeof(flag));

// 设置接收缓冲区大小
int buffer_size = 65536;
setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &buffer_size, sizeof(buffer_size));
```

## 11. 安全特性

### 11.1 输入验证

**消息长度检查**：
```c
int validate_message_length(diameter_header_t* header) {
    uint32_t length = ntohl_custom(*(uint32_t*)header->length) & 0x00FFFFFF;
    if (length < sizeof(diameter_header_t) || length > MAX_MESSAGE_SIZE) {
        return -1;
    }
    return 0;
}
```

**AVP 验证**：
```c
int validate_avp(avp_header_t* avp, int remaining_length) {
    uint32_t avp_length = ntohl(*(uint32_t*)avp->length) & 0x00FFFFFF;
    if (avp_length < sizeof(avp_header_t) || avp_length > remaining_length) {
        return -1;
    }
    return 0;
}
```

### 11.2 资源保护

**连接数限制**：
```c
#define MAX_CLIENTS_PER_LINK 10
#define MAX_TOTAL_CLIENTS 40

static int current_client_count = 0;
static pthread_mutex_t client_count_mutex = PTHREAD_MUTEX_INITIALIZER;
```

**内存使用限制**：
```c
#define MAX_BUFFER_SIZE 4096
#define MAX_MESSAGE_SIZE 65536

char* allocate_safe_buffer(size_t size) {
    if (size > MAX_BUFFER_SIZE) {
        return NULL;
    }
    return malloc(size);
}
```

### 11.3 错误处理

**异常恢复机制**：
```c
void handle_client_error(struct client_info* client, int error_code) {
    printf("客户端错误: %d, 正在清理连接\n", error_code);
    
    // 关闭套接字
    if (client->socket_fd >= 0) {
        close(client->socket_fd);
        client->socket_fd = -1;
    }
    
    // 标记为非活跃
    client->active = 0;
    
    // 触发重连机制
    connection_manager_start_reconnect(client);
}
```

## 12. 故障排除

### 12.1 常见问题

**端口占用问题**：
```bash
# 检查端口占用
netstat -tlnp | grep 8001

# 杀死占用进程
kill -9 <pid>
```

**连接超时问题**：
- 检查防火墙设置
- 验证网络连通性
- 调整超时参数

**内存泄漏问题**：
```bash
# 使用 valgrind 检测内存泄漏
valgrind --leak-check=full ./link_simulator
```

### 12.2 日志分析

**启用详细日志**：
```c
#define DEBUG_MODE 1

#if DEBUG_MODE
#define DEBUG_PRINT(fmt, ...) printf("[DEBUG] " fmt "\n", ##__VA_ARGS__)
#else
#define DEBUG_PRINT(fmt, ...)
#endif
```

**日志级别控制**：
```c
typedef enum {
    LOG_ERROR = 0,
    LOG_WARN = 1,
    LOG_INFO = 2,
    LOG_DEBUG = 3
} log_level_t;

void log_message(log_level_t level, const char* format, ...) {
    if (level <= current_log_level) {
        // 输出日志消息
    }
}
```

## 13. 总结

freeDiameter 链路模拟器是一个功能完整、设计精良的网络仿真系统，具有以下特点：

### 13.1 技术优势

- **完整的协议支持**：全面支持 Diameter 协议栈
- **精确的链路仿真**：真实模拟各种网络环境
- **高性能架构**：支持高并发和大规模连接
- **模块化设计**：便于扩展和维护
- **丰富的测试工具**：提供完整的测试和验证机制

### 13.2 应用价值

- **系统测试**：为航空通信系统提供可靠的测试环境
- **性能评估**：准确评估不同链路条件下的系统性能
- **算法验证**：验证链路选择和切换算法的有效性
- **培训支持**：为技术人员提供实践和学习平台

### 13.3 发展方向

- **智能化仿真**：引入机器学习算法优化仿真精度
- **云原生支持**：支持容器化部署和微服务架构
- **可视化监控**：提供图形化的监控和管理界面
- **标准化接口**：支持更多的行业标准和协议

链路模拟器作为 freeDiameter 系统的重要组成部分，为航空通信领域的技术发展和应用推广提供了强有力的支撑。通过持续的优化和扩展，它将继续为航空通信系统的可靠性和性能提升做出重要贡献。