# TFT 3GPP TS 23.060 格式说明

## 格式规范

根据 ARINC 839 §1.2.2.1（第92页），TFT 遵循 **3GPP TS 23.060** 格式。

### 完整语法

```
_iTFT=[<cid>,[<packet filter id>,<evaluation precedence>[,<source addr.mask>
       [,<dest addr.mask>[,<protocol number>[,<dest port range>
       [,<source port range>[,<ipsec spi>[,<tos and mask>
       [,<flow label>]]]]]]]]]]
```

### 字段说明

| 字段位置 | 字段名 | 格式 | 示例 | 说明 |
|---------|--------|------|------|------|
| 0 | CID | 数字 | `1` | Context ID（通常为空） |
| 1 | Packet Filter ID | 数字 | `1` | 包过滤器ID（可选） |
| 2 | Evaluation Precedence | 数字 | `0` | 优先级（可选） |
| **3** | **Source Address.Mask** | **a.b.c.d.m1.m2.m3.m4** | **192.168.0.0.255.255.255.0** | **源IP和掩码** |
| **4** | **Dest Address.Mask** | **a.b.c.d.m1.m2.m3.m4** | **10.16.0.0.255.255.0.0** | **目标IP和掩码** |
| **5** | **Protocol Number** | **数字** | **6** (TCP), **17** (UDP) | **协议** |
| **6** | **Dest Port Range** | **start.end** | **0.1023**, **80.80** | **目标端口范围** |
| 7 | Source Port Range | start.end | 0.65535 | 源端口范围 |
| 8 | IPsec SPI | 数字 | | IPsec参数（可选） |
| 9 | ToS and Mask | 数字 | | 服务类型（可选） |
| 10 | Flow Label | 数字 | | IPv6流标签（可选） |

**关键格式特征：**
- 逗号分隔字段
- IP地址和掩码使用**点分十进制**连接（8个八位组）
- 端口范围使用**点**连接（不是破折号）

## 标准示例（来自 ARINC 839）

### 示例 1：TCP 到公网端口 0-1023
```
_iTFT=,192.168.0.0.255.255.255.0,10.16.0.0.255.255.0.0,6,0.1023,0.65535,,,
```

**解析：**
- 源IP：192.168.0.0/24（192.168.0.0 & 255.255.255.0）
- 目标IP：10.16.0.0/16（10.16.0.0 & 255.255.0.0）
- 协议：TCP（6）
- 目标端口：0-1023
- 源端口：0-65535（任意）

### 示例 2：内网到公网任意TCP连接
```
_iTFT=,,172.16.0.0.255.255.128.0,0.0.0.0.0.0.0.0,6,0.65535,0.65535,,,
```

**解析：**
- 源IP：172.16.0.0/17
- 目标IP：0.0.0.0/0（**任意**）
- 协议：TCP（6）
- 目标端口：0-65535（任意）
- 源端口：0-65535（任意）

### 示例 3：内网到公网任意UDP连接
```
_iTFT=,,172.16.0.0.255.255.128.0,0.0.0.0.0.0.0.0,17,0.65535,0.65535,,,
```

**解析：**
- 源IP：172.16.0.0/17
- 目标IP：任意
- 协议：UDP（17）
- 端口：任意

## MAGIC 客户端配置示例

### 配置文件格式（`ife-01_magic.conf`）

```properties
# ========== TFT 流量过滤规则（3GPP TS 23.060 格式）==========

# 示例1：访问卫星网关10.2.2.0/24的HTTP/HTTPS服务
TFT_GROUND.1 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,80.80,0.65535,,,
TFT_GROUND.2 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,443.443,0.65535,,,

# 示例2：访问WIFI网关10.1.1.0/24的任意TCP端口
TFT_GROUND.3 = _iTFT=,192.168.126.5.255.255.255.255,10.1.1.0.255.255.255.0,6,0.65535,0.65535,,,

# 示例3：访问蜂窝网关10.3.3.0/24的DNS服务（UDP 53）
TFT_GROUND.4 = _iTFT=,192.168.126.5.255.255.255.255,10.3.3.0.255.255.255.0,17,53.53,0.65535,,,

# 示例4：访问任意公网IP的HTTPS（目标IP为0.0.0.0/0）
TFT_GROUND.5 = _iTFT=,192.168.126.5.255.255.255.255,0.0.0.0.0.0.0.0,6,443.443,0.65535,,,

# 反向流量（TFTtoAircraft）- 通常由网络自动分配，可选
TFT_AIR.1 = +CGTFT=,10.2.2.0.255.255.255.0,192.168.126.5.255.255.255.255,6,0.65535,80.80,,,
```

## 白名单配置示例（`Client_Profile.xml`）

```xml
<Traffic>
    <!-- 白名单：允许访问3个网关网段 -->
    <DestIPRange>10.1.1.0/24,10.2.2.0/24,10.3.3.0/24</DestIPRange>
    
    <!-- 白名单：允许端口范围 -->
    <DestPortRange>53,80,443,5000-6000</DestPortRange>
</Traffic>
```

## 验证逻辑

MAGIC 服务器会按照以下规则验证 TFT：

### ✅ 合法请求（会通过验证）

| TFT 请求 | 白名单 DestIPRange | 白名单 DestPortRange | 结果 |
|---------|-------------------|---------------------|------|
| 目标IP=10.2.2.5/32 | 10.2.2.0/24 | 80,443 | ✅ IP在范围内 |
| 目标端口=80-80 | 10.2.2.0/24 | 80,443 | ✅ 端口在列表内 |
| 目标IP=10.1.1.100/32 | 10.1.1.0/24 | 5000-6000 | ✅ IP和端口均在范围内 |

### ❌ 非法请求（会被拒绝）

| TFT 请求 | 白名单 DestIPRange | 白名单 DestPortRange | 错误原因 |
|---------|-------------------|---------------------|---------|
| 目标IP=192.168.1.1/32 | 10.2.2.0/24 | 80,443 | ❌ IP不在白名单 |
| 目标端口=8080-8080 | 10.2.2.0/24 | 80,443 | ❌ 端口不在白名单 |
| 目标IP=10.2.3.5/32 | 10.2.2.0/24 | 任意 | ❌ IP地址超出网段 |

## 错误码

验证失败时返回：
- **Result-Code**: `5003` (DIAMETER_AUTHORIZATION_REJECTED)
- **MAGIC-Status-Code**: `1036` (MAGIC_ERROR_TFT-INVALID)
- **Error-Message**: 详细错误原因

## 常见错误

### 错误1：使用简化格式

❌ **错误写法**：
```
TFT_GROUND.1 = permit out ip from 192.168.126.5 to 10.2.2.8
```

✅ **正确写法**：
```
TFT_GROUND.1 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.8.255.255.255.255,6,80.80,0.65535,,,
```

### 错误2：端口范围使用破折号

❌ **错误写法**：
```
TFT_GROUND.1 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,80-443,0.65535,,,
```

✅ **正确写法**（需要分两条规则）：
```
TFT_GROUND.1 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,80.80,0.65535,,,
TFT_GROUND.2 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,443.443,0.65535,,,
```

**或使用宽松范围：**
```
TFT_GROUND.1 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,80.443,0.65535,,,
```

### 错误3：IP/掩码分隔符错误

❌ **错误写法**：
```
TFT_GROUND.1 = _iTFT=,192.168.126.5/32,10.2.2.0/24,6,80.80,0.65535,,,
```

✅ **正确写法**：
```
TFT_GROUND.1 = _iTFT=,192.168.126.5.255.255.255.255,10.2.2.0.255.255.255.0,6,80.80,0.65535,,,
```

## IP/掩码转换工具

### CIDR 到 3GPP 格式转换表

| CIDR 表示法 | 3GPP 格式（IP.Mask） | 说明 |
|------------|---------------------|------|
| 192.168.126.5/32 | 192.168.126.5.255.255.255.255 | 单个主机 |
| 10.2.2.0/24 | 10.2.2.0.255.255.255.0 | /24网段（C类） |
| 10.1.0.0/16 | 10.1.0.0.255.255.0.0 | /16网段（B类） |
| 172.16.0.0/17 | 172.16.0.0.255.255.128.0 | /17网段（半个B类） |
| 0.0.0.0/0 | 0.0.0.0.0.0.0.0 | 任意IP |

## 测试命令

### 1. 检查服务器日志
```bash
sudo journalctl -u freeDiameterd -f | grep -E "TFT|whitelist|validation"
```

### 2. 验证配置加载
```bash
# 服务器启动时会显示白名单配置
# 查找：DestIPRange, DestPortRange
```

### 3. 发送MCCR请求后查看验证日志
```bash
# 成功日志示例：
# [app_magic] ✓ TFT whitelist validation passed (toGround)

# 失败日志示例：
# [app_magic] ✗ TFT whitelist validation FAILED: Destination IP outside whitelist
# [app_magic]   TFT: _iTFT=,192.168.126.5.255.255.255.255,10.5.5.0.255.255.255.0,6,80.80,...
# [app_magic]   Whitelist IP: 10.2.2.0/24
```

## 参考文献

1. **ARINC 839-2014** §1.2.2.1 - Traffic Flow Template Format（第92页）
2. **3GPP TS 23.060 V10.1.0** Section 15.3 - Traffic Flow Template
3. **ARINC 839-2014** §1.2.2.2 - White List Validation（第92-93页）

---

**最后更新**: 2025-12-25  
**版本**: 2.0 (3GPP TS 23.060 Compliant)
