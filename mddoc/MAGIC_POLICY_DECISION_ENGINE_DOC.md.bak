# MAGIC 策略引擎决策机制详解文档

## 1. 概述 (Overview)

MAGIC (Multi-link Aggregation Gateway for Internet Connectivity) 的核心是一个智能策略引擎。它负责在多条可能的通信链路（卫星、蜂窝网络/ATG、机场 WiFi）中，为每一个客户端请求动态选择**最佳**的传输路径。

决策过程不仅仅基于静态配置，还融合了实时链路状态、飞机飞行阶段、地理位置以及业务的 QoS 需求。

---

## 2. 核心设计思想 (Decision Philosophy)

策略引擎的设计遵循以下优先级原则：

1.  **安全优先 (Safety First)**: 驾驶舱关键数据（如 EFB、VoIP）永远具有最高优先级，且必须走最可靠的链路（通常是卫星）。
2.  **合规与隔离 (Compliance & Isolation)**: 即使有更快的链路，如果策略禁止（如安全域隔离），也不能使用。
3.  **成本优化 (Cost Efficiency)**: 在满足性能要求的前提下，优先使用低成本链路（WiFi > Cellular > Satcom）。
4.  **业务连续性 (Continuity)**: 避免频繁的链路切换（Flapping），通过“防抖动”机制保持连接稳定。
5.  **地理感知 (Context Awareness)**: 根据飞行阶段（地面、起降、巡航）自动切换策略集。

---

## 3. 关键配置参数详解 (Configuration Parameters)

决策过程依赖于三个核心配置文件的协同工作。

### 3.1 客户端画像 (`Client_Profile.xml`)
定义“**谁在请求**”以及“**它的权限边界**”。

| 参数 | 作用说明 | 决策影响 |
| :--- | :--- | :--- |
| **ProfileName** | 业务场景标识 (如 `cockpit_efb`) | 用于流量分类，映射到具体的策略规则。 |
| **Bandwidth** | 带宽限制 (Max/Guaranteed) | 这是一个**硬限制**。如果请求带宽超过 `MaxForward`，请求会被直接拒绝，不进入链路选择阶段。 |
| **PriorityClass** | 优先级 (1-9，1最高) | 决定流量分类。高优先级流量可以匹配更激进的保活策略。 |
| **QoSLevel** | 服务质量等级 (如 EF/AF/BE) | 用于识别实时业务（如语音），匹配低延迟链路。 |
| **AllowedDLMs** | 允许使用的链路白名单 | **一级过滤网**。只能使用此处列出的链路。例如这里的配置可禁止机务流量走昂贵的卫星链路。 |
| **PreferredDLM** | 首选链路 | **加分项**。如果此链路可用，评分时会获得额外加分 (+500)，增加被选中的概率。 |

### 3.2 链路特性 (`Datalink_Profile.xml`)
定义“**有哪些路**”以及“**路况如何**”。

| 参数 | 作用说明 | 决策影响 |
| :--- | :--- | :--- |
| **MaxForwardBW** | 链路最大带宽 | 用于计算**带宽余量**。余量越大，评分越高（负载均衡）。 |
| **Latency** | 链路延迟 (ms) | 影响链路评分。低延迟链路 (+100分) 优于高延迟链路。同时受策略中 `max_latency_ms` 的硬性约束。 |
| **DLMType** | 链路类型 (Sat/Cell/WiFi) | 类型本身带有基础评分权重（卫星稳定性高+5，蜂窝速度快+3）。 |
| **Coverage** | 覆盖范围 (经纬度/高度) | **物理限制**。结合 ADIF 的实时位置数据，如果飞机不在覆盖区，该链路直接被视为“不可用”。 |

### 3.3 中心策略 (`Central_Policy_Profile.xml`)
定义“**怎么选路**”以及“**规则集**”。

| 参数 | 作用说明 | 决策影响 |
| :--- | :--- | :--- |
| **PolicyRuleSet** | 策略规则集 | 根据 `flight_phases` (如 CRUISE, GATE) 激活不同的规则集。这是决策的**大前提**。 |
| **TrafficClass** | 流量类别定义 | 将客户端属性动态映射为类别 (如 `COCKPIT_DATA`)。 |
| **PathPreference** | 路径偏好 | 包含 `link_id` (链路) 和 `ranking` (排名)。`ranking` 越小，初始得分越高。 |
| **Action** | 动作 (`PROHIBIT`) | 如果设为 PROHIBIT，该链路会被强制剔除，即使物理上连通。 |
| **SwitchingPolicy** | 切换策略 | 定义 `MinDwellTime` (最小驻留时间) 和 `Hysteresis` (迟滞)，防止乒乓切换。 |

---

## 4. 决策过程详解 (The Logic Flow)

当一个客户端发起连接请求 (Session Request) 时，策略引擎 (`magic_policy.c`) 执行以下 6 步逻辑：

### 步骤 1: 客户端准入与校验
*   **输入**: Client ID, 请求带宽。
*   **逻辑**:
    1.  检查客户端是否存在且启用。
    2.  检查请求带宽是否超过 `Client_Profile` 中的 `MaxForward`。
*   **结果**: 如果超限，直接拒绝连接。

### 步骤 2: 环境感知与规则集加载
*   **输入**: 当前飞行阶段 (`flight_phase`)。
*   **逻辑**: 在 `Central_Policy_Profile` 中查找匹配当前阶段的 `<PolicyRuleSet>`。
    *   *例如：如果现在是 `GATE` (登机口)，加载地面策略集；如果是 `CRUISE` (巡航)，加载高空策略集。*
*   **思想**: **上下文感知**。同样的业务在地面和空中可能有完全不同的选路逻辑。

### 步骤 3: 动态流量分类 (Dynamic Classification)
*   **输入**: 客户端的 `PriorityClass`, `QoSLevel`, `ProfileName`。
*   **逻辑**: 按顺序匹配 `TrafficClassDefinitions`。
    1.  如果是 `PriorityClass=1` → 归类为 **COCKPIT_DATA** (驾驶舱数据)。
    2.  如果是 `QoSLevel=2` (EF) → 归类为 **INTERACTIVE** (实时交互)。
    3.  如果名字包含 `maint` → 归类为 **BULK_DATA** (大容量数据)。
    4.  其他 → **BEST_EFFORT**。
*   **思想**: **业务抽象**。将成百上千个具体的 Client ID 抽象为几类典型的流量模型进行管理。

### 步骤 4: 候选链路过滤 (The Sieve)
*   **逻辑**: 拿到所有物理链路，进行层层筛选：
    1.  **配置过滤**: 策略规则中标记为 `PROHIBIT` 的链路 → **剔除**。
    2.  **权限过滤**: 客户端 `AllowedDLMs` 名单中没有的链路 → **剔除**。
    3.  **状态过滤**: 链路当前处于 Down 状态或未初始化 → **剔除**。
    4.  **覆盖过滤**: 根据 ADIF 提供的飞机经纬度/高度，不在覆盖范围内的链路 → **剔除**。
    5.  **性能过滤**: (v2.0新增) 如果策略要求 `max_latency_ms="300"` 但链路延迟为 600ms → **剔除**。

### 步骤 5: 链路评分与竞选 (Scoring & Ranking)
*   **逻辑**: 对剩下的候选链路打分，分数高者得。
    $$ TotalScore = OrderScore + BWScore + LatencyScore + TypeScore + BonusScore $$
    
    *   **OrderScore (策略排名)**: `(10 - ranking) * 1000`。这是权重最大的部分，体现了管理员的意图。
    *   **BWScore (带宽余量)**: `(链路最大带宽 - 请求带宽) / 100`。余量越大分越高，实现**负载均衡**。
    *   **LatencyScore (延迟)**: 低延迟(<50ms) +100分，高延迟(>500ms) -50分。
    *   **BonusScore (首选奖励)**: 如果是客户端 `PreferredDLM`，+500分。

### 步骤 6: 防抖动检查 (Stability Check)
*   **场景**: 如果客户端已经连接在 Link A 上，现在评分发现 Link B 分数略高。
*   **逻辑**:
    1.  **最小驻留时间**: 检查在 Link A 上呆的时间是否超过 `MinDwellTime` (如60秒)。没超过则不切。
    2.  **信号迟滞**: 检查 Link B 的质量（带宽/信号）是否比 Link A 好出 `HysteresisPercentage` (如10%) 以上。如果没有显著变好，则不切。
*   **思想**: **稳定性大于微小的性能提升**。

---

## 5. 典型决策案例演示

### 案例 A: 飞机在登机口 (GATE)，机务下载数据
*   **环境**: 地面，有 WiFi (Gatelink)，有 4G，有卫星。
*   **客户端**: 维护终端 (Priority: Low, Allowed: WiFi, Cellular)。
*   **过程**:
    1.  规则集锁定 `GROUND_OPS`。
    2.  策略定义 WiFi 为 Ranking 1，4G 为 Ranking 2，卫星为 PROHIBIT。
    3.  **评分**: WiFi 获得 Ranking 1 的高分 (9000分) + 带宽极大 + 低延迟奖励。
    4.  **结果**: 选中 **WiFi**。如果 WiFi 断了，回退到 4G。绝不会走卫星（因为 PROHIBIT 且客户端不允许）。

### 案例 B: 飞机巡航中 (CRUISE)，飞行员使用 EFB
*   **环境**: 高空，只能用卫星 (Satcom) 或 ATG (Cellular)。
*   **客户端**: EFB (Priority: High, Allowed: Satcom, WiFi)。注意：EFB配置里可能不允许 Cellular。
*   **过程**:
    1.  规则集锁定 `HIGH_ALTITUDE_OPS`。
    2.  分类为 `COCKPIT_DATA`。
    3.  **过滤**: 
        *   WiFi: 高度超限/不在覆盖区 → 剔除。
        *   Cellular: 客户端 `AllowedDLMs` 不包含 → 剔除。
    4.  **结果**: 唯一候选者 **Satcom** 自动中标。即使 ATG 速度更快，由于安全策略限制（EFB不走公网 ATG），依然走卫星。

### 案例 C: VoIP 语音通话 (对延迟敏感)
*   **环境**: 降落阶段 (APPROACH)，卫星和 ATG 均可用。
*   **规则**: `LOW_ALTITUDE_OPS` 中定义 INTERACTIVE 类流量 `max_latency_ms="300"`。
*   **过程**:
    1.  **过滤**: 卫星链路延迟 600ms > 300ms 阈值 → **直接剔除**。
    2.  **结果**: 选中 **ATG/Cellular** (延迟 < 100ms)。保证了语音不卡顿。

---

## 6. 总结

MAGIC 策略引擎通过 **"分层过滤 + 加权评分"** 的机制，完美平衡了复杂的航空通信需求。它既能通过 XML 配置实现灵活的业务逻辑调整，又能通过硬编码的算法保证决策的实时性和稳定性。
