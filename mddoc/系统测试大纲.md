# MAGIC 系统测试大纲

**版本**: v1.0  
**日期**: 2025年12月26日  
**适用范围**: MAGIC (Mobile Air-Ground Integrated Communication) 系统基本功能测试

---

## 目录

1. [测试概述](#1-测试概述)
2. [测试环境](#2-测试环境)
3. [测试用例](#3-测试用例)
   - 3.1 [系统启动测试](#31-系统启动测试)
   - 3.2 [Diameter 协议测试](#32-diameter-协议测试)
   - 3.3 [会话管理测试](#33-会话管理测试)
   - 3.4 [策略引擎测试](#34-策略引擎测试)
   - 3.5 [链路管理测试](#35-链路管理测试)
   - 3.6 [数据平面测试](#36-数据平面测试)
   - 3.7 [故障恢复测试](#37-故障恢复测试)
   - 3.8 [性能测试](#38-性能测试)
4. [测试报告模板](#4-测试报告模板)

---

## 1. 测试概述

### 1.1 测试目的

验证 MAGIC 系统的基本功能是否符合 ARINC 839 规范要求，包括：
- 客户端认证与注册
- 通信资源请求与分配
- 链路选择与切换
- 数据平面路由控制
- 系统故障恢复能力

### 1.2 测试范围

| 模块 | 测试内容 | 优先级 |
|------|----------|--------|
| freeDiameter 核心 | 连接建立、消息收发 | P0 |
| app_magic 扩展 | MCAR/MCCA/MCCR/MCSR 消息处理 | P0 |
| 策略引擎 | 链路选择、飞行阶段切换 | P0 |
| 数据平面 | fwmark 路由、TFT 规则 | P0 |
| 会话管理 | 会话创建/更新/删除 | P1 |
| DLM 接口 | 链路状态上报、资源分配 | P1 |

### 1.3 通过标准

- 所有 P0 测试用例 100% 通过
- 所有 P1 测试用例 ≥ 95% 通过
- 无阻塞性 (Blocker) 缺陷
- 系统连续运行 1 小时无崩溃

---

## 2. 测试环境

### 2.1 硬件配置

| 设备 | 配置要求 |
|------|----------|
| 服务器 | 4核 CPU, 8GB RAM, 4个网卡 |
| 客户端 | 2核 CPU, 4GB RAM, 1个网卡 |

### 2.2 网络拓扑

```
客户端 (192.168.126.5)
        │
        │ ens39
        ▼
┌───────────────────────────────┐
│     MAGIC 服务器              │
│     192.168.126.1 (入口)      │
│                               │
│   ens37      ens38     ens35  │
│   10.2.2.2   10.3.3.3  10.1.1.1│
│   SATCOM     WIFI      CELLULAR│
└───────┬────────┬────────┬─────┘
        │        │        │
        ▼        ▼        ▼
     目标网络   目标网络   目标网络
```

### 2.3 软件版本

| 组件 | 版本 |
|------|------|
| freeDiameter | 1.5.0 |
| app_magic | 2.0 |
| dict_magic_839 | 1.0 |
| Linux Kernel | ≥ 4.15 |
| GnuTLS | ≥ 3.6 |

### 2.4 测试准备

```bash
# 1. 清理环境
pkill -9 freeDiameterd
pkill -9 magic_client
rm -f /tmp/*.sock
iptables -F
ip rule flush

# 2. 编译系统
cd /home/zhuwuhui/freeDiameter/build
make

# 3. 启动服务器
./freeDiameterd/freeDiameterd -c ../conf/magic_server.conf &

# 4. 启动客户端
cd magic_client/build
./magic_client
```

---

## 3. 测试用例

### 3.1 系统启动测试

#### TC-SYS-001: 服务器正常启动

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 freeDiameter 服务器能正常启动并加载 MAGIC 扩展 |
| **前置条件** | 配置文件正确，证书存在 |
| **测试步骤** | 1. 执行 `./freeDiameterd -c magic_server.conf`<br>2. 观察日志输出 |
| **预期结果** | - 日志显示 `app_magic extension loaded`<br>- 端口 3868 监听成功<br>- 无错误日志 |
| **优先级** | P0 |

#### TC-SYS-002: 客户端正常启动

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 magic_client 能正常启动并连接服务器 |
| **前置条件** | 服务器已启动 |
| **测试步骤** | 1. 执行 `./magic_client`<br>2. 输入 `connect` 命令<br>3. 输入 `status` 命令 |
| **预期结果** | - 显示 `连接成功`<br>- 状态显示 `STATE_OPEN` |
| **优先级** | P0 |

#### TC-SYS-003: 配置文件加载

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 XML 策略配置文件正确加载 |
| **前置条件** | 配置文件存在 |
| **测试步骤** | 1. 启动服务器<br>2. 检查日志中的配置加载信息 |
| **预期结果** | - 日志显示 `Loaded Central_Policy_Profile.xml`<br>- 日志显示 `Loaded Datalink_Profile.xml`<br>- 日志显示 `Loaded Client_Profile.xml` |
| **优先级** | P0 |

---

### 3.2 Diameter 协议测试

#### TC-DIA-001: MCAR (移动凭证访问请求)

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证客户端认证流程 |
| **前置条件** | 客户端已连接 |
| **测试步骤** | 1. 客户端执行 `mcar`<br>2. 观察响应 |
| **预期结果** | - 收到 MCAA 响应<br>- Result-Code = 2001 (DIAMETER_SUCCESS)<br>- 客户端状态变为 `已注册` |
| **优先级** | P0 |

#### TC-DIA-002: MCCR-Start (通信资源请求 - 启动)

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证新会话建立流程 |
| **前置条件** | 客户端已注册 |
| **测试步骤** | 1. 客户端执行 `mccr start 5000 10000 1 2`<br>2. 观察响应 |
| **预期结果** | - 收到 MCCA 响应<br>- Result-Code = 2001<br>- 返回 Bearer-ID<br>- 返回 Selected-DLM |
| **优先级** | P0 |

#### TC-DIA-003: MCCR-Modify (通信资源请求 - 修改)

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证会话修改流程 |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 客户端执行 `mccr modify <session_id> 8000 15000 1 2`<br>2. 观察响应 |
| **预期结果** | - 收到 MCCA 响应<br>- Result-Code = 2001<br>- Granted-BW 更新 |
| **优先级** | P0 |

#### TC-DIA-004: MCCR-Stop (通信资源请求 - 停止)

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证会话终止流程 |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 客户端执行 `mccr stop <session_id>`<br>2. 观察响应 |
| **预期结果** | - 收到 MCCA 响应<br>- Result-Code = 2001<br>- 会话状态变为 TERMINATED |
| **优先级** | P0 |

#### TC-DIA-005: MCSR (通信状态请求)

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证状态查询功能 |
| **前置条件** | 客户端已注册 |
| **测试步骤** | 1. 客户端执行 `mcsr`<br>2. 观察响应 |
| **预期结果** | - 收到 MCSA 响应<br>- 包含链路状态信息 |
| **优先级** | P1 |

#### TC-DIA-006: 无效消息处理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证系统对异常消息的处理 |
| **前置条件** | 客户端已连接 |
| **测试步骤** | 1. 发送格式错误的请求<br>2. 发送超长 AVP<br>3. 发送重复 Session-Id |
| **预期结果** | - 返回适当的错误码<br>- 系统不崩溃<br>- 日志记录错误信息 |
| **优先级** | P1 |

---

### 3.3 会话管理测试

#### TC-SES-001: 会话创建

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证会话正确创建 |
| **前置条件** | 客户端已注册 |
| **测试步骤** | 1. 发送 MCCR-Start<br>2. 查询会话状态 |
| **预期结果** | - Session-Id 唯一<br>- 会话状态为 ACTIVE<br>- 资源正确分配 |
| **优先级** | P0 |

#### TC-SES-002: 多会话管理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证同一客户端多会话场景 |
| **前置条件** | 客户端已注册 |
| **测试步骤** | 1. 创建会话 A (目标 10.2.2.8)<br>2. 创建会话 B (目标 10.3.3.8)<br>3. 分别查询两个会话 |
| **预期结果** | - 两个会话独立存在<br>- 资源分别计算<br>- 可分配不同链路 |
| **优先级** | P1 |

#### TC-SES-003: 会话超时清理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证超时会话自动清理 |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 建立会话<br>2. 等待超时时间 (默认 300s)<br>3. 查询会话状态 |
| **预期结果** | - 会话被自动清理<br>- 资源被释放<br>- 路由规则被删除 |
| **优先级** | P1 |

#### TC-SES-004: 会话挂起与恢复

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证链路中断时会话挂起 |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 建立会话 (使用 WIFI)<br>2. 模拟 WIFI 链路中断<br>3. 等待链路恢复<br>4. 查询会话状态 |
| **预期结果** | - 链路中断时会话状态变为 SUSPENDED<br>- 链路恢复后会话可恢复<br>- 或切换到备用链路 |
| **优先级** | P1 |

---

### 3.4 策略引擎测试

#### TC-POL-001: 飞行阶段切换

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证飞行阶段切换功能 |
| **前置条件** | 服务器已启动 |
| **测试步骤** | 1. 确认初始阶段为 PARKED<br>2. 切换到 TAXI<br>3. 切换到 TAKEOFF<br>4. 切换到 CRUISE<br>5. 切换到 LANDING<br>6. 切换回 PARKED |
| **预期结果** | - 每次切换日志记录正确<br>- 策略规则集正确更新<br>- 链路可用性随阶段变化 |
| **优先级** | P0 |

#### TC-POL-002: 链路优先级选择 - PARKED 阶段

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证地面停机阶段的链路选择 |
| **前置条件** | 飞行阶段为 PARKED，所有链路在线 |
| **测试步骤** | 1. 请求 BEST_EFFORT 业务<br>2. 请求 INTERACTIVE 业务<br>3. 请求 FLIGHT_CRITICAL 业务 |
| **预期结果** | - BEST_EFFORT → WIFI (优先级最高)<br>- INTERACTIVE → CELLULAR<br>- FLIGHT_CRITICAL → SATCOM |
| **优先级** | P0 |

#### TC-POL-003: 链路优先级选择 - CRUISE 阶段

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证巡航阶段的链路限制 |
| **前置条件** | 飞行阶段为 CRUISE |
| **测试步骤** | 1. 请求 FLIGHT_CRITICAL 业务<br>2. 请求 BULK_DATA 业务 |
| **预期结果** | - FLIGHT_CRITICAL → SATCOM (唯一允许)<br>- BULK_DATA → 拒绝 (CELLULAR/WIFI 在巡航禁用) |
| **优先级** | P0 |

#### TC-POL-004: 带宽限制检查

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证客户端带宽限制 |
| **前置条件** | 客户端最大带宽配置为 5 Mbps |
| **测试步骤** | 1. 请求 3 Mbps 带宽<br>2. 请求 10 Mbps 带宽 |
| **预期结果** | - 3 Mbps 请求成功<br>- 10 Mbps 请求被拒绝 (Result-Code = 5012) |
| **优先级** | P0 |

#### TC-POL-005: 链路负载均衡

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证高负载链路降级 |
| **前置条件** | 多条链路在线 |
| **测试步骤** | 1. 模拟 WIFI 链路 90% 负载<br>2. 请求 BEST_EFFORT 业务 |
| **预期结果** | - 虽然 WIFI 优先级最高，但因高负载降级<br>- 可能选择 CELLULAR 作为替代 |
| **优先级** | P1 |

---

### 3.5 链路管理测试

#### TC-LNK-001: 链路注册

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 DLM 链路注册 |
| **前置条件** | 服务器已启动 |
| **测试步骤** | 1. 启动 DLM 模拟器<br>2. 观察服务器日志 |
| **预期结果** | - 日志显示 `Link LINK_XXX registered`<br>- 链路状态为 ONLINE |
| **优先级** | P0 |

#### TC-LNK-002: 链路状态上报

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证链路状态变更通知 |
| **前置条件** | 链路已注册 |
| **测试步骤** | 1. 模拟链路状态变更 (UP → DOWN)<br>2. 观察服务器处理 |
| **预期结果** | - 日志显示 `Link LINK_XXX is now OFFLINE`<br>- 受影响会话状态更新 |
| **优先级** | P0 |

#### TC-LNK-003: 链路容量更新

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证链路容量动态更新 |
| **前置条件** | 链路已注册 |
| **测试步骤** | 1. 更新链路可用带宽<br>2. 请求资源分配 |
| **预期结果** | - 策略引擎使用最新容量信息<br>- 资源分配结果正确 |
| **优先级** | P1 |

#### TC-LNK-004: 心跳超时检测

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 DLM 心跳超时处理 |
| **前置条件** | 链路已注册 |
| **测试步骤** | 1. 停止 DLM 心跳<br>2. 等待超时 (默认 30s)<br>3. 观察链路状态 |
| **预期结果** | - 链路状态变为 OFFLINE<br>- 日志记录心跳超时 |
| **优先级** | P1 |

---

### 3.6 数据平面测试

#### TC-DP-001: fwmark 规则初始化

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 Mark Based Routing 初始化 |
| **前置条件** | 服务器已启动 |
| **测试步骤** | 1. 启动服务器<br>2. 检查 ip rule 列表 |
| **预期结果** | - 存在 `fwmark 100 lookup 100` 等规则<br>- 黑洞规则 `fwmark 99 lookup 99` 存在 |
| **验证命令** | `ip rule show | grep fwmark` |
| **优先级** | P0 |

#### TC-DP-002: TFT 规则添加

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 TFT 五元组打标规则 |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 建立会话 (src=192.168.126.5, dst=10.2.2.8, port=5000)<br>2. 检查 iptables mangle 表 |
| **预期结果** | - mangle PREROUTING 包含匹配规则<br>- 流量被正确打标 |
| **验证命令** | `iptables -t mangle -L PREROUTING -n` |
| **优先级** | P0 |

#### TC-DP-003: 流量路由验证

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证流量走正确链路 |
| **前置条件** | 会话已建立，分配 SATCOM 链路 |
| **测试步骤** | 1. 客户端发送 UDP 数据到 10.2.2.8:5000<br>2. 抓包验证出口接口 |
| **预期结果** | - 流量从 ens37 (SATCOM) 出去<br>- 源 IP 被 MASQUERADE 转换 |
| **验证命令** | `tcpdump -i ens37 host 10.2.2.8` |
| **优先级** | P0 |

#### TC-DP-004: 默认阻断规则

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证未授权流量被阻断 |
| **前置条件** | 无活动会话 |
| **测试步骤** | 1. 客户端直接发送数据到外网<br>2. 观察流量是否通过 |
| **预期结果** | - 流量被 DROP<br>- iptables 计数器增加 |
| **验证命令** | `iptables -L FORWARD -n -v | grep DROP` |
| **优先级** | P0 |

#### TC-DP-005: 会话关闭后规则清理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证会话关闭后路由规则被删除 |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 建立会话并验证规则存在<br>2. 关闭会话<br>3. 检查规则是否删除 |
| **预期结果** | - mangle 规则被删除<br>- FORWARD 放行规则被删除<br>- conntrack 条目被清除 |
| **优先级** | P0 |

#### TC-DP-006: NAT MASQUERADE 验证

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证基于 fwmark 的 NAT |
| **前置条件** | 会话已建立 |
| **测试步骤** | 1. 发送流量<br>2. 检查 conntrack 表 |
| **预期结果** | - conntrack 显示 SNAT 转换<br>- 回程流量正确返回客户端 |
| **验证命令** | `conntrack -L | grep 192.168.126` |
| **优先级** | P0 |

---

### 3.7 故障恢复测试

#### TC-FLT-001: 链路故障切换

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证链路故障时的自动切换 |
| **前置条件** | 会话使用 WIFI 链路 |
| **测试步骤** | 1. 建立会话 (WIFI)<br>2. 模拟 WIFI 故障<br>3. 观察切换行为 |
| **预期结果** | - 检测到链路故障<br>- 自动切换到备用链路 (CELLULAR)<br>- 会话保持 (或重建) |
| **优先级** | P0 |

#### TC-FLT-002: 服务器重启恢复

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证服务器重启后状态恢复 |
| **前置条件** | 有活动会话 |
| **测试步骤** | 1. 记录当前会话状态<br>2. 重启服务器<br>3. 客户端重新连接<br>4. 查询会话状态 |
| **预期结果** | - 客户端能重新连接<br>- 可重新建立会话<br>- 数据平面规则重新配置 |
| **优先级** | P1 |

#### TC-FLT-003: 客户端断连处理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证客户端断连后的资源清理 |
| **前置条件** | 有活动会话 |
| **测试步骤** | 1. 强制关闭客户端 (`kill -9`)<br>2. 等待服务器检测断连<br>3. 检查资源状态 |
| **预期结果** | - 服务器检测到断连<br>- 会话被清理<br>- 路由规则被删除 |
| **优先级** | P1 |

#### TC-FLT-004: DLM 重连处理

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证 DLM 断连后的重连 |
| **前置条件** | DLM 已注册 |
| **测试步骤** | 1. 停止 DLM 进程<br>2. 重启 DLM<br>3. 观察注册过程 |
| **预期结果** | - DLM 自动重新注册<br>- 链路状态恢复<br>- 受影响会话恢复或重建 |
| **优先级** | P1 |

---

### 3.8 性能测试

#### TC-PRF-001: 并发会话数

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证系统并发会话处理能力 |
| **测试步骤** | 1. 启动多个客户端<br>2. 每个客户端建立多个会话<br>3. 观察系统响应 |
| **预期结果** | - 支持 ≥ 100 并发会话<br>- 响应时间 < 100ms<br>- 内存使用稳定 |
| **优先级** | P1 |

#### TC-PRF-002: 消息吞吐量

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证消息处理吞吐量 |
| **测试步骤** | 1. 连续发送 1000 个 MCCR 请求<br>2. 统计处理时间 |
| **预期结果** | - 吞吐量 ≥ 100 msg/s<br>- 无消息丢失 |
| **优先级** | P1 |

#### TC-PRF-003: 长时间稳定性

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证系统长时间运行稳定性 |
| **测试步骤** | 1. 系统连续运行 24 小时<br>2. 周期性建立/关闭会话<br>3. 监控资源使用 |
| **预期结果** | - 无内存泄漏<br>- 无崩溃<br>- 响应时间稳定 |
| **优先级** | P1 |

#### TC-PRF-004: 数据平面性能

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证数据平面路由性能 |
| **测试步骤** | 1. 使用 iperf3 测试吞吐量<br>2. 测试延迟 |
| **预期结果** | - 吞吐量接近链路物理带宽<br>- 附加延迟 < 1ms |
| **验证命令** | `iperf3 -c <target> -t 60` |
| **优先级** | P1 |

---

## 4. 测试报告模板

### 4.1 测试摘要

| 项目 | 内容 |
|------|------|
| 测试日期 | YYYY-MM-DD |
| 测试版本 | vX.X |
| 测试人员 | |
| 测试环境 | |

### 4.2 测试结果统计

| 分类 | 总数 | 通过 | 失败 | 阻塞 | 通过率 |
|------|------|------|------|------|--------|
| 系统启动 | 3 | | | | |
| Diameter 协议 | 6 | | | | |
| 会话管理 | 4 | | | | |
| 策略引擎 | 5 | | | | |
| 链路管理 | 4 | | | | |
| 数据平面 | 6 | | | | |
| 故障恢复 | 4 | | | | |
| 性能测试 | 4 | | | | |
| **总计** | **36** | | | | |

### 4.3 详细测试记录

| 用例 ID | 测试名称 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|----------|----------|----------|------|------|
| TC-SYS-001 | 服务器正常启动 | | | PASS/FAIL | |
| TC-SYS-002 | 客户端正常启动 | | | PASS/FAIL | |
| ... | ... | ... | ... | ... | ... |

### 4.4 缺陷列表

| 缺陷 ID | 关联用例 | 严重程度 | 描述 | 状态 |
|---------|----------|----------|------|------|
| BUG-001 | TC-XXX-XXX | Critical/Major/Minor | | Open/Fixed |

### 4.5 测试结论

- [ ] 所有 P0 测试通过
- [ ] P1 测试通过率 ≥ 95%
- [ ] 无阻塞性缺陷
- [ ] 建议发布 / 建议修复后重测

---

## 附录

### A. 常用调试命令

```bash
# 查看 iptables 规则
iptables -L -n -v
iptables -t mangle -L -n -v
iptables -t nat -L -n -v

# 查看策略路由
ip rule show
ip route show table 100

# 查看连接跟踪
conntrack -L

# 查看 freeDiameter 日志
tail -f /tmp/fd_server.log

# 抓包
tcpdump -i any -n port 3868 or port 5000
```

### B. 配置文件位置

| 文件 | 路径 |
|------|------|
| 服务器配置 | `conf/magic_server.conf` |
| 策略配置 | `extensions/app_magic/config/Central_Policy_Profile.xml` |
| 链路配置 | `extensions/app_magic/config/Datalink_Profile.xml` |
| 客户端配置 | `extensions/app_magic/config/Client_Profile.xml` |

### C. 错误码参考

| 错误码 | 含义 |
|--------|------|
| 2001 | DIAMETER_SUCCESS |
| 3002 | DIAMETER_UNABLE_TO_COMPLY |
| 5012 | DIAMETER_RESOURCES_EXCEEDED |
| 5030 | MAGIC_USER_UNKNOWN |
| 5031 | MAGIC_IDENTITIES_DONT_MATCH |

---

**文档结束**
