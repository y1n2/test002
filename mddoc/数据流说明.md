# MAGIC 防火墙与路由规则数据流说明

## 1. 系统架构概述

MAGIC系统使用Linux策略路由和iptables防火墙实现精细的流量控制，确保：
- ✅ 未授权客户端无法访问任何网络资源
- ✅ 已授权客户端只能访问分配的链路和目标
- ✅ 会话关闭后立即阻断流量
- ✅ 保护网关和基础设施IP不被客户端直接访问

---

## 2. 网络拓扑

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端网段                                │
│              192.168.126.0/24 (ens39)                       │
│                                                             │
│  ┌──────────────┐          ┌──────────────┐                │
│  │ 客户端1      │          │ 客户端2      │                │
│  │ 192.168.126.5│          │ 192.168.126.6│                │
│  └──────┬───────┘          └──────┬───────┘                │
│         │                         │                         │
│         └────────────┬────────────┘                         │
│                      │                                      │
│              ┌───────┴────────┐                             │
│              │  服务器网关     │                             │
│              │ 192.168.126.1  │                             │
│              │    (ens39)     │                             │
└──────────────┴────────────────┴─────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │   MAGIC 服务器/路由器      │
        │                           │
        │  防火墙 + 策略路由引擎     │
        │  NAT + 流量控制            │
        │                           │
        └─┬───────────┬───────────┬─┘
          │           │           │
    ┌─────┴─────┐ ┌──┴────┐ ┌───┴─────┐
    │ ens37     │ │ens38  │ │ens35    │
    │ 10.2.2.2  │ │10.3.3.3│ │10.1.1.1 │
    │ SATCOM    │ │ WIFI  │ │CELLULAR │
    └─────┬─────┘ └──┬────┘ └───┬─────┘
          │          │           │
    ┌─────┴─────┐ ┌──┴────┐ ┌───┴─────┐
    │ 10.2.2.8  │ │目标   │ │ 目标    │
    │ 业务目标  │ │服务器 │ │ 服务器  │
    └───────────┘ └───────┘ └─────────┘
```

---

## 3. 防火墙规则详解

### 3.1 INPUT 链（保护服务器本机）

**目的**：防止客户端直接访问网关IP和基础设施端口

```bash
# 阻止客户端ping网关IP（ICMP）
iptables -A INPUT -s 192.168.126.0/24 -d 10.1.1.1 -p icmp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.2.2.2 -p icmp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.3.3.3 -p icmp -j DROP

# 阻止客户端访问网关的TCP/UDP服务
iptables -A INPUT -s 192.168.126.0/24 -d 10.1.1.1 -p tcp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.2.2.2 -p tcp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.3.3.3 -p tcp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.1.1.1 -p udp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.2.2.2 -p udp -j DROP
iptables -A INPUT -s 192.168.126.0/24 -d 10.3.3.3 -p udp -j DROP
```

**规则优先级**: 高（确保基础设施安全）

---

### 3.2 OUTPUT 链（控制发出流量）

**目的**：允许服务器本机流量，控制客户端发出流量

```bash
# 规则1: 服务器本机IP白名单（最高优先级）
iptables -I OUTPUT 1 -s 192.168.126.1 -j ACCEPT

# 规则2-3: ipset集合白名单（已授权客户端）
iptables -I OUTPUT 2 -m set --match-set magic_data src -j ACCEPT
iptables -I OUTPUT 3 -m set --match-set magic_control src -j ACCEPT

# 规则N: 客户端网段默认阻断（兜底规则）
iptables -A OUTPUT -s 192.168.126.0/24 -j DROP
```

**处理流程**：
1. 检查是否为服务器本机IP → ACCEPT
2. 检查是否在 magic_data 集合 → ACCEPT（业务流量）
3. 检查是否在 magic_control 集合 → ACCEPT（控制流量）
4. 其他客户端网段流量 → DROP

---

### 3.3 FORWARD 链（转发流量控制）

**目的**：控制跨网段转发流量（客户端访问业务目标）

> **ARINC 839 合规说明**：采用"连接追踪 + TFT精确规则"模式，而非ipset直接放行。
> 这确保只有MCCR明确申请的流量才能通过，防止"全通"漏洞。

```bash
# 规则1: 连接追踪（已建立连接快速通过，提高性能）
iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT

# 规则2-N: 会话建立后动态添加的TFT精确规则（五元组匹配）
# 示例：允许客户端访问特定目标的特定服务
iptables -I FORWARD 2 -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j ACCEPT
iptables -I FORWARD 2 -s 192.168.126.5 -d 10.2.2.8 -p icmp -j ACCEPT

# 规则N: 客户端网段默认阻断（兜底规则）
iptables -A FORWARD -s 192.168.126.0/24 -j DROP
```

**注意**：
- ⚠️ 不再使用 `ipset` 在FORWARD链直接放行，避免"全通"漏洞
- ✅ `ipset` 仅用于管理层面的快速查询或mangle表预筛选
- ✅ 精确规则基于TFT五元组，确保最小权限原则

---

### 3.4 NAT 表 POSTROUTING 链（源地址转换）

**目的**：将客户端IP转换为出口网关IP，实现跨网段通信

> **ARINC 839 合规说明**：使用FwMark匹配进行NAT，支持多链路并发NAT需求。

```bash
# 系统初始化时配置（基于Mark的NAT规则）
iptables -t nat -A POSTROUTING -m mark --mark 100 -j MASQUERADE  # SATCOM链路NAT
iptables -t nat -A POSTROUTING -m mark --mark 101 -j MASQUERADE  # WIFI链路NAT
iptables -t nat -A POSTROUTING -m mark --mark 102 -j MASQUERADE  # CELLULAR链路NAT
```

**转换效果**（以SATCOM为例）：
- 原始数据包：`192.168.126.5 → 10.2.2.8`（Mark=100）
- NAT后数据包：`10.2.2.2 → 10.2.2.8`
- 回程数据包：`10.2.2.8 → 10.2.2.2`
- 反向NAT后：`10.2.2.8 → 192.168.126.5`

**优势**：
- ✅ 使用mark匹配比IP匹配更精确
- ✅ 支持同一客户端通过不同链路访问不同目标
- ✅ NAT规则静态配置，无需动态增删

---

## 4. 策略路由规则

### 4.1 路由表设计

| 路由表ID | 用途 | 默认路由 |
|---------|------|---------|
| main (254) | 系统默认路由 | 根据主路由表 |
| 100 | LINK_SATCOM 数据路由 | `dev ens37` 或 `via <gateway>` |
| 101 | LINK_WIFI 数据路由 | `dev ens38` 或 `via <gateway>` |
| 102 | LINK_CELLULAR 数据路由 | `dev ens35` 或 `via <gateway>` |
| 99 | 黑洞路由（会话关闭） | `blackhole default` |

### 4.2 策略路由规则（ip rule）- 基于FwMark

> **ARINC 839 合规说明**：采用基于标记的路由（Mark Based Routing），而非基于源IP的路由。
> 这允许同一客户端的不同业务流走不同链路（如VoIP走SATCOM，文件下载走WIFI）。

```bash
# 系统初始化时执行（静态规则，只需配置一次）
ip rule add fwmark 100 lookup 100   # SATCOM标记 → SATCOM路由表
ip rule add fwmark 101 lookup 101   # WIFI标记 → WIFI路由表  
ip rule add fwmark 102 lookup 102   # CELLULAR标记 → CELLULAR路由表
ip rule add fwmark 99 lookup 99     # 黑洞标记 → 黑洞路由表

# 查看当前规则
ip rule list

# 示例输出：
# 0:     from all lookup local
# 100:   from all fwmark 0x64 lookup 100   ← SATCOM (0x64=100)
# 101:   from all fwmark 0x65 lookup 101   ← WIFI (0x65=101)
# 102:   from all fwmark 0x66 lookup 102   ← CELLULAR (0x66=102)
# 99:    from all fwmark 0x63 lookup 99    ← 黑洞 (0x63=99)
# 32766: from all lookup main
# 32767: from all lookup default
```

**规则优先级**：
- 99-102: FwMark路由规则（静态）
- 32766: main路由表
- 32767: default路由表

### 4.3 Mangle表打标规则（动态）

> 在MCCR建立会话时，根据TFT五元组（源IP、目的IP、协议、源端口、目的端口）动态添加打标规则。

```bash
# MCCR建立时动态添加（示例：客户端访问HTTP服务走SATCOM）
iptables -t mangle -A PREROUTING -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j MARK --set-mark 100

# 同一客户端的另一个业务流走WIFI
iptables -t mangle -A PREROUTING -s 192.168.126.5 -d 10.3.3.8 -p tcp --dport 443 -j MARK --set-mark 101

# 会话关闭时删除对应规则
iptables -t mangle -D PREROUTING -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j MARK --set-mark 100
```

**优势**：
- ✅ 同一客户端可同时使用多条链路
- ✅ 精确到五元组级别的流量控制
- ✅ 完全符合ARINC 839 TFT规范

---

## 5. ipset 集合管理

> **ARINC 839 合规说明**：ipset仅用于管理层面的快速查询和mangle表预筛选，不再在filter表FORWARD链直接放行。

### 5.1 magic_control 集合

**用途**：MCAR阶段认证成功的客户端白名单（用于控制面流量）

**生命周期**：
- 添加时机：`MCAR` 认证成功
- 删除时机：`STR` 会话终止

**对应规则**（仅用于OUTPUT链控制面流量）：
```bash
iptables -I OUTPUT -m set --match-set magic_control src -j ACCEPT
```

### 5.2 magic_data 集合

**用途**：MCCR阶段资源分配成功的客户端白名单（用于管理查询）

**生命周期**：
- 添加时机：`MCCR start` 资源分配成功
- 删除时机：`MCCR stop` 或 `STR` 会话终止

**用途变更说明**：
- ⚠️ 不再用于FORWARD链直接放行（避免"全通"漏洞）
- ✅ 用于快速查询客户端状态
- ✅ 可用于mangle表预筛选优化性能

**集合内容示例**：
```bash
$ sudo ipset list magic_data
Name: magic_data
Members:
192.168.126.5
192.168.126.6
```

---

## 6. 数据流场景分析

### 场景 A: 未建立会话（初始状态）

```
客户端 192.168.126.5 ping 10.2.2.8
│
├─ 数据包离开客户端
│  └─ 源IP: 192.168.126.5, 目的IP: 10.2.2.8
│
├─ 到达服务器 ens39 接口
│
├─ 进入 FORWARD 链（因为目的IP不是本机）
│  ├─ 规则1: ESTABLISHED,RELATED? → NO（无已建立连接）
│  ├─ 规则2-N: TFT精确规则? → NO（无匹配规则）
│  └─ 规则N: -s 192.168.126.0/24 -j DROP → ✗ 匹配，DROP
│
└─ 数据包被丢弃 ✗ 不通
```

**结果**：❌ 不通（被FORWARD DROP规则阻断）

---

### 场景 B: MCAR认证成功（控制流量）

```
执行: mcar auth
结果: 192.168.126.5 被添加到 magic_control 集合

客户端 192.168.126.5 → Diameter控制消息 → 服务器:3868
│
├─ 进入 OUTPUT 链（客户端发出）
│  ├─ 规则3: match-set magic_control? → ✓ YES
│  └─ ACCEPT
│
└─ 控制流量正常 ✓
```

**结果**：✅ 控制流量通（Diameter消息可以正常交互）

---

### 场景 C: MCCR建立链路（业务流量）

```
执行: mccr start cockpit_efb_mission 1024 5000 1 1
结果（基于TFT五元组的精确控制）:
  1. 192.168.126.5 被添加到 magic_data 集合（用于状态管理）
  2. 添加TFT精确FORWARD规则（filter表）: 
     iptables -I FORWARD -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j ACCEPT
  3. 添加Mangle打标规则（决定路由）:
     iptables -t mangle -I PREROUTING -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j MARK --set-mark 100
  4. NAT规则已在初始化时配置（基于mark）:
     iptables -t nat -A POSTROUTING -m mark --mark 100 -j MASQUERADE

客户端 192.168.126.5 访问 10.2.2.8:80 (HTTP)
│
├─ 数据包: 192.168.126.5 → 10.2.2.8:80
│
├─ 到达服务器 ens39，进入 mangle PREROUTING 链
│  ├─ 规则匹配: -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80
│  └─ MARK: 打上标记 100
│
├─ 进入 FORWARD 链（filter表）
│  ├─ 规则1: ESTABLISHED,RELATED? → NO（首包）
│  ├─ 规则2: TFT精确规则匹配? → ✓ YES
│  └─ ACCEPT
│
├─ 进入 POSTROUTING 链（NAT）
│  ├─ NAT规则匹配: -m mark --mark 100
│  └─ MASQUERADE: 源IP改为 10.2.2.2
│
├─ 路由决策（基于FwMark策略路由）
│  ├─ ip rule: fwmark 100 lookup 100
│  └─ 路由表100: default dev ens37（SATCOM）
│
├─ 数据包从 ens37 发出
│  └─ 10.2.2.2 → 10.2.2.8:80
│
└─ 回程流量
   ├─ 10.2.2.8:80 → 10.2.2.2 到达 ens37
   ├─ 反向NAT: 目的IP改为 192.168.126.5
   ├─ FORWARD规则: ESTABLISHED,RELATED → ✓ ACCEPT
   └─ 从 ens39 返回客户端 ✓
```

**结果**：✅ 业务流量通（完整的双向通信）

**多链路并发示例**：
```
同一客户端同时发起两个会话：
├─ 会话1: 192.168.126.5 → 10.2.2.8:80 → MARK 100 → SATCOM（VoIP）
└─ 会话2: 192.168.126.5 → 10.3.3.8:443 → MARK 101 → WIFI（文件下载）
```

---

### 场景 D: Ping 网关 IP（安全保护）

```
客户端 192.168.126.5 ping 10.2.2.2
│
├─ 数据包: 192.168.126.5 → 10.2.2.2 (ICMP)
│
├─ 到达服务器 ens39
│
├─ 目的IP是本机 → 进入 INPUT 链
│  ├─ 规则8: -s 192.168.126.0/24 -d 10.2.2.2 -p icmp -j DROP
│  └─ ✗ DROP
│
└─ 数据包被丢弃 ✗ 不通
```

**结果**：❌ 不通（保护网关IP，这是预期行为）

**原因**：
- 网关IP只用于路由，不应被客户端直接访问
- 防止客户端攻击基础设施
- 符合航空安全标准

---

### 场景 E: 会话关闭（流量立即阻断）

```
执行: str (Session-Termination-Request)
结果（基于TFT的精确清理）:
  1. 从 magic_data 和 magic_control 集合中删除 192.168.126.5
  2. 删除mangle打标规则: 
     iptables -t mangle -D PREROUTING -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j MARK --set-mark 100
  3. 删除FORWARD TFT精确规则:
     iptables -D FORWARD -s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j ACCEPT
  4. 临时添加黑洞打标规则（快速阻断残留流量）:
     iptables -t mangle -I PREROUTING -s 192.168.126.5 -j MARK --set-mark 99
  5. 清理conntrack连接: conntrack -D -s 192.168.126.5
  6. 延迟后删除黑洞打标规则（可选）

客户端 192.168.126.5 访问 10.2.2.8:80
│
├─ 数据包: 192.168.126.5 → 10.2.2.8:80
│
├─ 进入 mangle PREROUTING 链
│  ├─ 规则1: 黑洞打标规则? → ✓ YES（临时）
│  └─ MARK: 打上标记 99
│
├─ 路由决策（基于FwMark）
│  ├─ ip rule: fwmark 99 lookup 99
│  └─ 路由表99: blackhole default → 丢弃
│
└─ 或者进入 FORWARD 链（无黑洞规则时）
   ├─ 规则1: ESTABLISHED,RELATED? → NO（conntrack已清理）
   ├─ 规则2-N: TFT精确规则? → NO（已删除）
   └─ 规则N: -s 192.168.126.0/24 -j DROP → ✓ 匹配，DROP
```

**结果**：❌ 不通（会话关闭后立即阻断）

---

## 7. 规则初始化流程

### 7.1 服务器启动时（magic_dataplane_init）

```c
1. 初始化黑洞路由表
   ip route add blackhole default table 99

2. 添加网段级DROP规则（兜底规则）
   iptables -A OUTPUT -s 192.168.126.0/24 -j DROP
   iptables -A FORWARD -s 192.168.126.0/24 -j DROP

3. 添加服务器IP白名单
   iptables -I OUTPUT 1 -s 192.168.126.1 -j ACCEPT

4. 添加连接追踪规则（FORWARD链首条，提高性能）
   iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT

5. 初始化ipset集合（清空历史状态）
   ipset create magic_control hash:ip -exist
   ipset flush magic_control
   ipset create magic_data hash:ip -exist
   ipset flush magic_data

6. 添加控制面ipset匹配规则（仅OUTPUT链）
   iptables -I OUTPUT 2 -m set --match-set magic_control src -j ACCEPT

7. 初始化FwMark策略路由规则（静态，只需配置一次）
   ip rule add fwmark 100 lookup 100 priority 100  # SATCOM
   ip rule add fwmark 101 lookup 101 priority 101  # WIFI
   ip rule add fwmark 102 lookup 102 priority 102  # CELLULAR
   ip rule add fwmark 99 lookup 99 priority 99     # 黑洞

8. 初始化基于Mark的NAT规则（静态）
   iptables -t nat -A POSTROUTING -m mark --mark 100 -j MASQUERADE
   iptables -t nat -A POSTROUTING -m mark --mark 101 -j MASQUERADE
   iptables -t nat -A POSTROUTING -m mark --mark 102 -j MASQUERADE

9. 添加INPUT链保护规则
   iptables -A INPUT -s 192.168.126.0/24 -d 10.1.1.1 -p icmp -j DROP
   iptables -A INPUT -s 192.168.126.0/24 -d 10.2.2.2 -p icmp -j DROP
   iptables -A INPUT -s 192.168.126.0/24 -d 10.3.3.3 -p icmp -j DROP
   (同样添加TCP/UDP保护)
```

### 7.2 链路注册时（DLM启动）

```c
1. DLM_SATCOM 启动
   magic_dataplane_register_link("LINK_SATCOM", "ens37", "10.2.2.2")
   
   结果:
   - 使用预分配的路由表 ID: 100
   - 创建路由表: ip route add default dev ens37 table 100
   - 或: ip route add default via <gateway> dev ens37 table 100

2. DLM_WIFI 启动
   magic_dataplane_register_link("LINK_WIFI", "ens38", "10.3.3.3")
   
   结果:
   - 使用预分配的路由表 ID: 101
   - 创建路由表: ip route add default dev ens38 table 101
```

### 7.3 MCCR会话建立时（动态规则）

```c
mccr_start_handler() 执行:

1. 验证TFT是否在Profile白名单内

2. 添加TFT精确FORWARD规则（filter表）
   iptables -I FORWARD 2 -s <ClientIP> -d <DestIP> -p <Proto> --dport <Port> -j ACCEPT

3. 添加Mangle打标规则（决定路由）
   iptables -t mangle -I PREROUTING -s <ClientIP> -d <DestIP> -p <Proto> --dport <Port> -j MARK --set-mark <LinkMark>

4. 更新ipset（用于状态管理）
   ipset add magic_data <ClientIP>
```

---

## 8. 常见问题诊断

### Q1: 客户端无法访问任何地址

**检查步骤**：
```bash
# 1. 检查ipset集合
sudo ipset list magic_data | grep <客户端IP>

# 2. 检查mangle打标规则
sudo iptables -t mangle -L PREROUTING -n -v | grep <客户端IP>

# 3. 检查FORWARD TFT规则
sudo iptables -L FORWARD -n -v | grep <客户端IP>

# 4. 检查FwMark策略路由
ip rule list | grep fwmark
```

### Q2: 能ping通10.2.2.8但不通10.2.2.2

**答案**：这是正常的！
- 10.2.2.2 是网关IP，被INPUT链DROP规则保护
- 10.2.2.8 是业务目标，通过FORWARD链转发

### Q3: 会话关闭后仍能访问

**检查步骤**：
```bash
# 1. 确认mangle打标规则已删除
sudo iptables -t mangle -L PREROUTING -n -v

# 2. 确认FORWARD TFT规则已删除
sudo iptables -L FORWARD -n -v

# 3. 确认conntrack已清理
sudo conntrack -L | grep <客户端IP>

# 4. 手动清理（如果服务未自动清理）
sudo iptables -t mangle -D PREROUTING -s <客户端IP> -d <目标IP> -p tcp --dport <端口> -j MARK --set-mark <mark>
sudo iptables -D FORWARD -s <客户端IP> -d <目标IP> -p tcp --dport <端口> -j ACCEPT
sudo conntrack -D -s <客户端IP>
```

### Q4: 同一客户端需要同时使用多条链路

**方案**：基于TFT五元组的打标路由
```bash
# 示例：VoIP走SATCOM，文件下载走WIFI
# VoIP流量（UDP 5060）
iptables -t mangle -A PREROUTING -s 192.168.126.5 -p udp --dport 5060 -j MARK --set-mark 100

# 文件下载流量（TCP 443）
iptables -t mangle -A PREROUTING -s 192.168.126.5 -p tcp --dport 443 -j MARK --set-mark 101
```

---

## 9. 规则优先级总结

### Mangle表 PREROUTING 链（打标决定路由）
1. TFT精确打标规则 (`-s <ClientIP> -d <DestIP> -p <Proto> --dport <Port> -j MARK --set-mark <LinkMark>`)
2. 黑洞打标规则（会话关闭临时）(`-s <ClientIP> -j MARK --set-mark 99`)

### Filter表 OUTPUT 链（从上到下检查）
1. 服务器IP白名单 (`-s 192.168.126.1 -j ACCEPT`)
2. magic_control 集合 (`-m set --match-set magic_control src -j ACCEPT`)
3. 客户端网段DROP (`-s 192.168.126.0/24 -j DROP`)

### Filter表 FORWARD 链
1. 连接追踪 (`-m state --state ESTABLISHED,RELATED -j ACCEPT`)
2. TFT精确规则 (`-s 192.168.126.5 -d 10.2.2.8 -p tcp --dport 80 -j ACCEPT`)
3. 客户端网段DROP (`-s 192.168.126.0/24 -j DROP`)

### Filter表 INPUT 链
1. 网关保护ICMP DROP (`-s 192.168.126.0/24 -d 10.2.2.2 -p icmp -j DROP`)
2. 网关保护TCP/UDP DROP
3. 默认 ACCEPT（其他流量）

### NAT表 POSTROUTING 链
1. 基于Mark的NAT (`-m mark --mark 100 -j MASQUERADE`)

### 策略路由优先级（基于FwMark，静态配置）
- 优先级 99: 黑洞路由 (`fwmark 99 lookup 99`)
- 优先级 100: SATCOM路由 (`fwmark 100 lookup 100`)
- 优先级 101: WIFI路由 (`fwmark 101 lookup 101`)
- 优先级 102: CELLULAR路由 (`fwmark 102 lookup 102`)
- 优先级 32766: main路由表
- 优先级 32767: default路由表

---

## 10. 安全机制总结

| 机制 | 作用 | 实现方式 |
|-----|------|---------|
| 默认拒绝 | 未授权客户端无法访问 | OUTPUT/FORWARD DROP规则 |
| TFT精确控制 | 只允许申请的五元组流量 | mangle打标 + filter精确规则 |
| 连接追踪 | 已建立连接快速通过 | ESTABLISHED,RELATED规则 |
| 网关保护 | 客户端不能访问基础设施 | INPUT链DROP规则 |
| 基于Mark的NAT | 支持多链路并发NAT | `-m mark --mark <n> -j MASQUERADE` |
| FwMark策略路由 | 同一客户端多业务流走不同链路 | `ip rule fwmark` + 多路由表 |
| 会话跟踪 | 自动清理断开的会话 | conntrack + ipset |
| 黑洞路由 | 会话关闭立即阻断 | `fwmark 99 lookup 99` (blackhole) |

---

## 11. ARINC 839 合规性说明

本设计采用**基于标记的路由（Mark Based Routing）**，完全符合ARINC 839 TFT（流量流模板）规范：

| 要求 | 实现方式 | 状态 |
|-----|---------|------|
| 五元组精确控制 | mangle表TFT打标规则 | ✅ 符合 |
| 多业务并发 | 同一客户端不同流量可走不同链路 | ✅ 符合 |
| 最小权限原则 | FORWARD链仅允许申请的精确流量 | ✅ 符合 |
| 会话隔离 | 每个TFT独立的打标和放行规则 | ✅ 符合 |
| 快速阻断 | conntrack清理 + 黑洞打标 | ✅ 符合 |

**与原设计对比**：

| 方面 | 原设计（Source Based） | 新设计（Mark Based） |
|-----|----------------------|---------------------|
| 路由粒度 | 源IP级别 | 五元组级别 |
| 多链路并发 | ❌ 不支持 | ✅ 支持 |
| TFT合规 | ⚠️ 部分符合 | ✅ 完全符合 |
| 规则动态性 | ip rule动态增删 | ip rule静态，mangle动态 |
| 安全性 | ipset可能导致"全通" | TFT精确控制 |

---

**文档版本**: 2.0  
**最后更新**: 2025-12-26  
**适用版本**: MAGIC Server v2.0+  
**合规标准**: ARINC 839 TFT规范
