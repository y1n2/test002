# MAGIC 证书生成工具

符合 ARINC 839/842 标准的航空 TLS 证书批量生成工具

---

## 📦 功能特性

- ✅ **批量证书生成**: 一键生成 CA 根证书、服务器证书、客户端证书
- ✅ **符合航空标准**: 
    - 遵循 ARINC 842 航空 PKI 标准 (支持 Mode S 地址扩展自动注入)
    - **符合 3GPP TS 23.060 标准的 TFT 格式**: 支持精确到端口和协议的流量过滤
    - **符合 ARINC 839 标准的 NAPT 格式**: 支持 SNAT/DNAT 及 `%LinkIp%` 动态占位符
- ✅ **系统集成自动化**: 
    - 自动更新 freeDiameter ACL 白名单 (`acl_wl.conf`)
    - **自动生成生产级业务策略** (`Client_Profile.xml`): 包含认证、带宽、QoS、链路策略、会话、流量、位置 7 个完整配置段
    - 自动生成服务器端 freeDiameter 配置文件 (`fd_server.conf`)
    - 自动生成客户端 freeDiameter 配置文件 (`fd_*.conf`)
    - **自动生成客户端 MAGIC 业务配置文件** (`*_magic.conf`): **支持通过 XML 自定义业务参数**（带宽、QoS、认证等）
    - **自动注入 Mode S 地址 (OtherName)**: 无需手动 OpenSSL 操作
- ✅ **灵活配置**: 基于 XML 配置文件, 可为每个客户端定制不同的业务策略
- ✅ **安全保障**: 自动设置私钥文件权限 (600), 默认使用 SECURE256 加密强度方案
- ✅ **生产就绪**: v1.2.2 生成的所有配置文件（服务器+客户端）与手工配置完全一致，可直接部署到生产环境

---

## 🚀 快速开始

### 1. 安装依赖

```bash
# Ubuntu/Debian
sudo apt-get install python3 python3-pip -y
pip3 install cryptography
```

### 2. 编辑配置文件

```bash
# 修改 cert_config.xml 中的 CommonName, IP 等字段
vim cert_config.xml
```

### 3. 运行生成工具

```bash
python3 cert_generator.py cert_config.xml
```

### 4. 查看生成的产物

```bash
ls -lh ./output/
```

**输出示例**:

```
output/
├── ca.crt                    (CA 根证书)
├── ca.key                    (CA 私钥, 权限 600)
├── magic-server.crt          (服务器证书)
├── magic-server.key          (服务器私钥, 权限 600)
├── efb-01.crt                (客户端证书)
├── efb-01.key                (客户端私钥, 权限 600)
│
├── client_fd_config/         (📂 客户端 freeDiameter 配置目录)
│   ├── fd_efb-01.conf
│   ├── fd_ife-01.conf
│   └── fd_magic-client.conf
│
├── client_magic_config/      (📂 客户端 MAGIC 业务配置目录)
│   ├── efb-01_magic.conf
│   ├── ife-01_magic.conf
│   └── magic-client_magic.conf
│
└── server_profile/           (📂 服务器端策略配置目录)
    ├── Client_Profile.xml    (完整的客户端策略配置)
    └── fd_server.conf        (服务器端 freeDiameter 配置)
```

---

## 🔗 系统集成说明

本工具 v1.2.2 会自动生成以下配置文件：

### 1. ACL 白名单 (`conf/acl_wl.conf`)
工具会自动将 `cert_config.xml` 中定义的所有客户端 `CommonName` 添加到 freeDiameter 的 ACL 准入列表中，确保 TLS 握手后身份验证通过。

### 2. 服务器端策略配置 (`output/server_profile/Client_Profile.xml`)
**v1.2.2 新改进**: 工具现在会在 `output/server_profile/` 目录下生成独立的 `Client_Profile.xml`，包含所有客户端的完整策略配置。

**v1.2.2 重大增强**: 工具现在会生成**生产级完整配置**，包含以下 7 个关键配置段：

- **① 认证配置 (Auth)**: 自动注入客户端标识、密码、IMSI、IP 地址等认证参数。
- **② 带宽策略 (Bandwidth)**: 设置前向/回程最大带宽（默认 20Mbps/5Mbps）、突发速率、带宽保障等级。
- **③ QoS 策略 (QoS)**: 配置优先级类型、优先级等级、允许的 QoS 级别（0/1/2）。
- **④ 链路策略 (LinkPolicy)**: 定义 SATCOM、WiFi、蜂窝网络的优先级、限速及故障切换策略。
- **⑤ 会话管理 (Session)**: 设置会话超时时间（默认 3600 秒）、最大并发会话数（默认 5）。
- **⑥ 流量控制 (Traffic)**: 启用流量计费、目标 IP 范围限制、流量分类模板（TFT）配置。
- **⑦ 位置感知 (Location)**: 配置飞行各阶段（8 个阶段）的服务策略、高度范围（0-60000 英尺）。

**工作模式**:
- **自动清理**: 删除旧的自动生成条目（标注 `<!-- Auto-generated by cert_generator.py -->`）。
- **完整创建**: 根据 `cert_config.xml` 中的客户端信息创建包含上述全部 7 段的完整配置。
- **IP 同步**: 自动将证书 SAN 中的 IP 地址同步到 `<SourceIP>` 字段，确保业务层与传输层认证一致。

**配置示例**（自动生成的完整结构）:
```xml
<Client id="auto_profile_EFB-01.B-929A.CES">
  <!-- Auto-generated by cert_generator.py v1.2.2 at 2025-12-25 -->
  <Auth>
    <ClientIdentity>EFB-01.B-929A.CES</ClientIdentity>
    <Password>magic123</Password>
    <IMSI>460011234567890</IMSI>
    <SourceIP>192.168.126.5</SourceIP>
  </Auth>
  <Bandwidth>
    <MaxForward>20000000</MaxForward>
    <MaxReturn>5000000</MaxReturn>
    <BurstForward>25000000</BurstForward>
    <BurstReturn>8000000</BurstReturn>
    <GuaranteedClass>2</GuaranteedClass>
  </Bandwidth>
  <QoS>
    <PriorityType>1</PriorityType>
    <PriorityClass>3</PriorityClass>
    <AllowedLevels>0,1,2</AllowedLevels>
  </QoS>
  <LinkPolicy>
    <SATCOM><Priority>1</Priority><MaxRate>10000000</MaxRate><Failover>true</Failover></SATCOM>
    <WiFi><Priority>2</Priority><MaxRate>50000000</MaxRate><Failover>true</Failover></WiFi>
    <Cellular><Priority>3</Priority><MaxRate>5000000</MaxRate><Failover>false</Failover></Cellular>
  </LinkPolicy>
  <Session>
    <Timeout>3600</Timeout>
    <MaxSessions>5</MaxSessions>
  </Session>
  <Traffic>
    <AccountingEnabled>true</AccountingEnabled>
    <DestIPRange>0.0.0.0/0</DestIPRange>
    <TFTTemplate>default</TFTTemplate>
  </Traffic>
  <Location>
    <FlightPhase phase="taxi"><Service>Best-Effort</Service><Altitude>0-100</Altitude></FlightPhase>
    <FlightPhase phase="takeoff"><Service>Guaranteed</Service><Altitude>0-10000</Altitude></FlightPhase>
    <FlightPhase phase="climb"><Service>Guaranteed</Service><Altitude>10000-30000</Altitude></FlightPhase>
    <FlightPhase phase="cruise"><Service>Premium</Service><Altitude>30000-45000</Altitude></FlightPhase>
    <FlightPhase phase="descent"><Service>Guaranteed</Service><Altitude>45000-10000</Altitude></FlightPhase>
    <FlightPhase phase="approach"><Service>Guaranteed</Service><Altitude>10000-1000</Altitude></FlightPhase>
    <FlightPhase phase="landing"><Service>Best-Effort</Service><Altitude>1000-0</Altitude></FlightPhase>
    <FlightPhase phase="parking"><Service>Best-Effort</Service><Altitude>0</Altitude></FlightPhase>
  </Location>
</Client>
```

### 3. freeDiameter 配置文件生成 (`output/client_fd_config/fd_*.conf`)
- **服务器端 (`fd_server.conf`)**: 生成完整的服务器配置，自动关联生成的证书、ACL 路径及 MAGIC 业务扩展。
- **客户端 (`client_fd_config/fd_*.conf`)**: 为每个客户端生成开箱即用的 freeDiameter 配置，预配置了服务器连接地址、TLS 证书及安全参数。

### 4. MAGIC 业务配置文件生成 (`output/client_magic_config/*_magic.conf`)
**v1.2.2 新增功能**: 自动为每个客户端生成完整的 MAGIC 业务配置文件，包含：
- **认证信息**: USERNAME、CLIENT_PASSWORD、SERVER_PASSWORD
- **带宽参数**: REQUESTED_BW、REQUESTED_RETURN_BW、REQUIRED_BW、REQUIRED_RETURN_BW
- **QoS 策略**: QOS_LEVEL、PRIORITY_CLASS、PRIORITY
- **会话管理**: TIMEOUT、KEEP_REQUEST、AUTO_DETECT
- **流量过滤**: TFT_GROUND、TFT_AIR 规则
- **Diameter 路由**: DESTINATION_REALM（自动从服务器 CN 提取）

**配置示例** (`client_magic_config/efb-01_magic.conf`):
```properties
CLIENT_ID           = EFB-01.B-929A.CES
TAIL_NUMBER         = B-929A
AIRCRAFT_TYPE       = C929
DESTINATION_REALM   = example.com

PROFILE_NAME        = IP_DATA
REQUESTED_BW        = 12000000
REQUESTED_RETURN_BW = 3000000
REQUIRED_BW         = 4000000
REQUIRED_RETURN_BW  = 1000000

QOS_LEVEL           = 2
PRIORITY_CLASS      = 6
MAX_BW              = 20000000
PRIORITY            = 8

USERNAME            = EFB-01
CLIENT_PASSWORD     = magic123
SERVER_PASSWORD     = 1111

TIMEOUT             = 900
KEEP_REQUEST        = 1
AUTO_DETECT         = 1
ACCOUNTING_ENABLED  = 1

TFT_GROUND.1        = permit out ip from 192.168.126.5 to 10.2.2.8
TFT_AIR.1           = permit in ip from 10.2.2.8 to 192.168.126.5
```

**文件权限**: 自动设置为 600 以保护认证凭据。

### 5. Mode S 地址自动注入 (ARINC 842)
工具会自动解析 XML 中的 `<OtherName>` 标签，并将其作为 `OtherName` 扩展注入到证书的 Subject Alternative Name (SAN) 中。这消除了以往需要手动使用 OpenSSL 配置文件进行签署的复杂步骤。

---

## 📖 配置文件示例

### 东方航空 C929 机队配置

```xml
<CertificateConfig>
  <OutputDirectory>./output/ces-c929</OutputDirectory>
  
  <CA>
    <Country>CN</Country>
    <State>Shanghai</State>
    <Organization>China Eastern Airlines</Organization>
    <CommonName>CES-MAGIC-Root-CA</CommonName>
    <KeySize>4096</KeySize>
    <ValidityDays>3650</ValidityDays>  <!-- 10 年 -->
    <OutputPrefix>ca</OutputPrefix>
  </CA>
  
  <Servers>
    <Server>
      <Country>CN</Country>
      <Organization>China Eastern Airlines</Organization>
      <CommonName>magic-c929-001.ces.com</CommonName>
      <KeySize>2048</KeySize>
      <ValidityDays>1095</ValidityDays>  <!-- 3 年 -->
      <OutputPrefix>server-c929-001</OutputPrefix>
      
      <SubjectAltNames>
        <DNS>magic-c929-001.ces.com</DNS>
        <IP>192.168.100.10</IP>
        <OtherName>
          <OID>1.3.6.1.4.1.13712.842.1.1</OID>  <!-- ARINC 842 Mode S OID -->
          <Value>780ABC</Value>  <!-- Mode S 地址 -->
        </OtherName>
      </SubjectAltNames>
    </Server>
  </Servers>
  
  <Clients>
    <Client>
      <Country>CN</Country>
      <Organization>China Eastern Airlines</Organization>
      <CommonName>EFB-Pilot-01</CommonName>
      <KeySize>2048</KeySize>
      <ValidityDays>365</ValidityDays>  <!-- 1 年 -->
      <OutputPrefix>client-efb-pilot-01</OutputPrefix>
      
      <!-- 可选：MAGIC 业务配置参数（不配置则使用默认值） -->
      <MagicConfig>
        <TailNumber>B-929A</TailNumber>
        <AircraftType>C929</AircraftType>
        <ProfileName>IP_DATA</ProfileName>
        
        <!-- 带宽配置 (单位: bps) -->
        <RequestedBW>12000000</RequestedBW>         <!-- 12 Mbps -->
        <RequestedReturnBW>3000000</RequestedReturnBW>
        <RequiredBW>4000000</RequiredBW>
        <RequiredReturnBW>1000000</RequiredReturnBW>
        <MaxBW>20000000</MaxBW>
        
        <!-- QoS 配置 -->
        <QoSLevel>2</QoSLevel>                      <!-- 0-3 -->
        <PriorityClass>6</PriorityClass>            <!-- 1-8 -->
        <Priority>8</Priority>
        <CostTolerance>2.0</CostTolerance>
        
        <!-- 认证信息 -->
        <Username>EFB-Pilot-01</Username>
        <ClientPassword>secure_password_here</ClientPassword>
        <ServerPassword>1111</ServerPassword>
        
        <!-- 会话管理 -->
        <Timeout>900</Timeout>
        <KeepRequest>1</KeepRequest>
        <AutoDetect>1</AutoDetect>
        <AccountingEnabled>1</AccountingEnabled>
      </MagicConfig>
    </Client>
  </Clients>
</CertificateConfig>
```

**参数说明**：
- `<MagicConfig>` 段可选，不配置则使用默认值
- 所有字段都可以根据实际需求调整
- **带宽单位为 bps**（例如：12000000 = 12 Mbps）
- **密码建议生产环境修改**，避免使用默认值

---

## 🔒 证书验证

```bash
# 验证证书链
openssl verify -CAfile output/ca.crt output/server-magic.crt
openssl verify -CAfile output/ca.crt output/client-efb-01.crt

# 查看证书详情
openssl x509 -in output/server-magic.crt -text -noout

# 验证 SAN 扩展
openssl x509 -in output/server-magic.crt -text | grep -A 5 "Subject Alternative Name"
```

---

## 📦 部署说明

### 1. 服务器端部署
运行工具后，服务器端的 `conf/acl_wl.conf` 和 `extensions/app_magic/config/Client_Profile.xml` 已自动更新。您只需：
1. 将 `output/ca.crt`、`output/magic-server.crt`、`output/magic-server.key` 拷贝到服务器证书目录。
2. 将 `output/fd_server.conf` 作为 freeDiameter 启动配置（或合并到现有配置）。
3. 重启 freeDiameter 服务以加载新配置。

### 2. 客户端部署
**完整部署流程** - 对于每个客户端（如 `efb-01`）：

1. **拷贝证书文件**:
   ```bash
   # 创建证书目录
   mkdir -p /opt/magic/certs
   
   # 拷贝证书和私钥
   cp output/ca.crt /opt/magic/certs/
   cp output/efb-01.crt /opt/magic/certs/
   cp output/efb-01.key /opt/magic/certs/
   chmod 600 /opt/magic/certs/efb-01.key
   ```

2. **拷贝配置文件**:
   ```bash
   # 创建配置目录
   mkdir -p /opt/magic/conf
   
   # 拷贝 freeDiameter 配置
   cp output/client_fd_config/fd_efb-01.conf /opt/magic/conf/
   
   # 拷贝 MAGIC 业务配置
   cp output/client_magic_config/efb-01_magic.conf /opt/magic/conf/
   chmod 600 /opt/magic/conf/efb-01_magic.conf
   ```

3. **启动客户端**:
   ```bash
   # 使用双配置文件启动（freeDiameter + MAGIC 业务）
   ./magic_client -c /opt/magic/conf/fd_efb-01.conf \
                  -m /opt/magic/conf/efb-01_magic.conf
   ```

4. **验证连接**:
   ```bash
   # 检查客户端日志，应该看到：
   # - TLS 握手成功
   # - CER/CEA 交换成功
   # - MCAR 认证成功
   ```

**快速测试** (使用相对路径):
```bash
cd /home/zhuwuhui/freeDiameter/magic_client/build
./magic_client -c ../../tools/cert_generator/output/client_fd_config/fd_efb-01.conf \
               -m ../../tools/cert_generator/output/client_magic_config/efb-01_magic.conf
```

---

## 📚 文档

| 文档 | 说明 |
|------|------|
| [USER_GUIDE.md](USER_GUIDE.md) | 用户手册 (安装、配置、使用方法) |
| [DESIGN.md](DESIGN.md) | 软件设计文档 (架构、API、扩展性) |
| [cert_config.xml](cert_config.xml) | XML 配置文件示例 |

---

## 🔐 安全最佳实践

1. ✅ 所有私钥文件 (*.key) 权限自动设置为 600
2. ⚠️ CA 私钥 (ca.key) 应妥善保管,避免泄露
3. ✅ 生产环境应使用 HSM (硬件安全模块) 存储 CA 私钥
4. ✅ 机载设备私钥应存储在 TPM 2.0 芯片
5. ✅ 定期更新证书:
   - CA 证书: 每 8 年
   - 服务器证书: 每 2 年
   - 客户端证书: 每 9 个月

---

## 📋 符合标准

- ✅ **ARINC 839**: MAGIC 系统架构和协议定义
- ✅ **ARINC 842**: 航空 PKI 证书策略 (Mode S 地址绑定)
- ✅ **ARINC 822A**: Gatelink 安全要求 (TLS 1.2+)
- ✅ **IETF RFC 5280**: X.509 公钥基础设施证书和 CRL 规范

---

## 🛠️ 故障排查

### 提示 "ModuleNotFoundError: No module named 'cryptography'"

```bash
pip3 install cryptography
```

### 提示 "PermissionError: [Errno 13] Permission denied"

```bash
sudo mkdir -p ./output
sudo chown $USER:$USER ./output
```

### 证书验证失败 "unable to get local issuer certificate"

```bash
# 确保使用 -CAfile 参数
openssl verify -CAfile ca.crt server-magic.crt
```

---

## 📝 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| **1.2.2** | **2025-12-24** | **生产级增强**: ① 客户端业务策略生成完整化（7 段配置）② **新增客户端 MAGIC 业务配置文件自动生成** (`*_magic.conf`) |
| 1.2.1 | 2025-12-24 | **自动化增强**: 支持 ARINC 842 Mode S 地址 (OtherName) 自动注入，无需手动 OpenSSL 操作 |
| 1.2.0 | 2025-12-24 | **功能增强**: 增加服务器端 freeDiameter 配置文件 (`fd_server.conf`) 自动生成 |
| 1.1.0 | 2025-12-24 | **重大更新**: 集成 ACL 白名单、MAGIC 业务策略自动同步及客户端配置生成 |
| 1.0.0 | 2025-12-24 | 初始版本,支持 CA/服务器/客户端证书批量生成 |

---

## 📞 技术支持

- **文档**: [USER_GUIDE.md](USER_GUIDE.md)
- **问题反馈**: magic-support@example.com

---

**作者**: MAGIC 开发团队  
**许可**: 内部使用
